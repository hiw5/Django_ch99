

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Django ORM Cookbook 2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>


<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="https://django-orm-cookbook-ko.readthedocs.io/en/latest/" />

<link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'index'
</script>

<script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html#document-index" class="icon icon-home"> Django ORM Cookbook
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-introduction">이 책의 소개</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-query">1. 장고 ORM이 실행하는 실제 SQL 질의문을 확인할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-or_query">2. OR 연산으로 일부 조건을 하나라도 만족하는 항목을 구하려면 어떻게 하나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-and_query">3. AND 연산으로 여러 조건을 모두 만족하는 항목을 구하려면 어떻게 하나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-notequal_query">4. NOT 연산으로 조건을 부정하려면 어떻게 하나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-union">5. 동일한 모델 또는 서로 다른 모델에서 구한 쿼리셋들을 합할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-select_some_fields">6. 필요한 열만 골라 조회하려면 어떻게 하나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-subquery">7. 장고에서 서브쿼리 식을 사용할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-f_query">8. 필드의 값을 서로 비교하여 항목을 선택할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-filefield">9. FileField에 파일이 들어있지 않은 행은 어떻게 구할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-join">10. 두 모델을 결합(JOIN)하려면 어떻게 하나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-second_largest">11. 두번째로 큰 항목은 어떻게 구하죠?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-duplicate">12. 특정 열의 값이 동일한 항목은 어떻게 찾나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-distinct">13. 쿼리셋에서 고유한 필드 값을 가진 항목은 어떻게 구하나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-query_relatedtool">14. Q 객체를 이용해 복잡한 질의를 수행하는 방법은 무엇인가요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-aggregation">15. 기록된 항목의 집계를 구할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-random">16. 항목을 무작위로 뽑고 싶습니다. 효율적인 방법이 있을까요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-func_expressions">17. 장고가 지원하지 않는 데이터베이스 함수를 사용할 수 있나요?</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-multiple_objects">1. 여러 개의 행을 한번에 생성하는 방법이 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-copy">2. 기존에 저장된 행을 복사해 새로 저장하는 방법은 무엇인가요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-singleton">3. 특정 모델의 항목이 하나만 생성되도록 강제하는 방법이 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-update_denormalized_fields">4. 모델 인스턴스를 저장할 때, 다른 모델에 반정규화된 필드를 함께 갱신하는 방법이 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-truncate">5. TRUNCATE 문을 수행하는 방법이 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-signals">6. 모델 인스턴스가 생성·갱신될 때 발생하는 시그널에는 어떤 것이 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-datetime">7. 시간 정보를 다른 양식으로 변환하여 데이터베이스에 저장하려면 어떻게 해야 하나요?</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-asc_or_desc">1. 쿼리셋을 오름차순/내림차순으로 정렬할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-case_insensitive">2. 대문자·소문자를 구별하지 않고 정렬하려면 어떻게 하나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-order_by_two">3. 여러 개의 필드를 기준으로 정렬하는 방법이 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-order_by_related_model">4. 외래 키로 연결된 다른 표의 열을 기준으로 정렬할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-order_by_annotated_field">5. 계산 필드를 기준으로 정렬할 수 있나요?</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-one_to_one">1. 일대일 관계는 어떻게 나타내나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-one_to_many">2. 일대다 관계는 어떻게 나타내나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-many_to_many">3. 다대다 관계는 어떻게 나타내나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-self_fk">4. 모델에 자기 참조 외래 키를 정의할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-existing_database">5. 기존 데이터베이스를 장고 모델로 옮길 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-database_view">6. 데이터베이스 뷰에 대응하는 모델을 정의할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-generic_models">7. 분류·댓글처럼 아무 모델이나 가리킬 수 있는 범용 모델을 정의할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-table_name">8. 모델에 연결된 표의 이름을 지정할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-column_name">9. 모델 필드의 데이터베이스 열 이름을 지정할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-null_vs_blank">10. <code class="code docutils literal notranslate"><span class="pre">null=True</span></code> 와 <code class="code docutils literal notranslate"><span class="pre">blank=True</span></code> 의 차이가 무엇인가요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-uuid">11. 기본 키(PK)로 ID 대신 UUID를 사용할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-slugfield">12. 슬러그 필드를 사용할 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-multiple_databases">13. 장고 프로젝트 하나에서 여러 개의 데이터베이스를 사용할 수 있나요?</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-numqueries">1. 질의 횟수가 고정된 횟수만큼만 일어나는지 확인할 수 있을까요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-keepdb">2. 데이터베이스를 재사용하여 테스트 실행 속도를 높일 수 있나요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-refresh_from_db">3. 모델 객체를 데이터베이스에서 다시 읽어들일 수 있나요?</a></li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html#document-index">Django ORM Cookbook</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="https://books.agiliq.com/">Books</a> &raquo;</li>
      <li><a href="index.html#document-index">Django Admin Cookbook</a> &raquo;</li>
        
      <li>Django ORM Cookbook 2.0 documentation</li>
    
    
    <a href="mailto:hello@agiliq.com" target="_blank" class="btn contact-top">hello@agiliq.com</a>

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="orm">
<h1>장고 ORM 요리책<a class="headerlink" href="#orm" title="Permalink to this headline">¶</a></h1>
<p>『장고 ORM 요리책(Django ORM Cookbook)』은 장고의 ORM(객체 관계 매핑) 기능과 모델 기능을 활용하는 다양한 레시피(조리법)를 담은 책입니다. 장고는 모델-템플릿-뷰(MTV) 프레임워크입니다. 이 책은 그 가운데 ‘모델’에 대해 상세히 다룹니다.</p>
<p>이 책은 “장고 ORM/쿼리셋/모델으로 ~을 하는 방법은 무엇인가요?”와 같은 질문 50여 개와 그 답을 담고 있습니다.</p>
<img alt="_images/BookCover.jpg" src="_images/BookCover.jpg" />
<div class="toctree-wrapper compound">
<span id="document-introduction"></span><div class="section" id="id1">
<h2>이 책의 소개<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>장고 ORM은 장고의 핵심 구성요소 가운데 하나로, 데이터베이스 시스템을 직접 다루지 않고도 데이터베이스를 활용할 수 있도록 하는 편리하고도 강력한 인터페이스입니다. “간단한 것을 쉽게, 어려운 것을 가능하게” 해 주는 고마운 기능이죠.</p>
<p>이 책은 여러 가지 예제로 문제 상황을 직접 다뤄보며 장고 ORM을 익히도록 합니다. 여러분의 장고 ORM의 이해도를 높여 줄 50여 개의 질문을 준비했습니다.</p>
<div class="section" id="id2">
<h3>이 책을 읽는 방법<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>이 책의 각 장은 각각 질문을 하나씩 다룹니다. 비슷한 주제를 다루는 장들은 서로 모아 두었습니다. 이 책을 읽는 방법은 크게 두 가지가 있습니다.</p>
<ol class="arabic simple">
<li>특정한 질문에 관한 답을 찾는다면 그 질문을 다루는 장과 그와 연결된 장을 함께 읽으세요.</li>
<li>장고 ORM과 모델 계층에 대한 이해도를 높이고 싶다면 책을 처음부터 차례대로 읽으세요.</li>
</ol>
</div>
</div>
</div>
<div class="section" id="id1">
<h2>정보를 조회하고 필요한 항목을 선별하는 방법<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-query"></span><div class="section" id="orm-sql">
<h3>장고 ORM이 실행하는 실제 SQL 질의문을 확인할 수 있나요?<a class="headerlink" href="#orm-sql" title="Permalink to this headline">¶</a></h3>
<p>장고 ORM이 실행하는 질의문 또는 우리가 작성한 코드에 대응하는 SQL 질의문이 무엇인지 확인하고 싶을 때가 있습니다. SQL 질의문을 구하고 싶은 <code class="code docutils literal notranslate"><span class="pre">queryset.query</span></code> 의 <code class="code docutils literal notranslate"><span class="pre">str</span></code> 을 확인하면 됩니다. 간단하죠?</p>
<p><code class="code docutils literal notranslate"><span class="pre">Event</span></code> 라는 모델이 있을 때, 이 모델의 모든 행을 데이터베이스에서 읽어오려면 <code class="code docutils literal notranslate"><span class="pre">Event.objects.all()</span></code> 과 같은 코드를 작성하면 됩니다. 이렇게 구한 쿼리셋의 <code class="code docutils literal notranslate"><span class="pre">str(queryset.query)</span></code> 를 확인하여 SQL 질의문을 살펴봅시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<span class="go">SELECT &quot;events_event&quot;.&quot;id&quot;, &quot;events_event&quot;.&quot;epic_id&quot;,</span>
<span class="go">    &quot;events_event&quot;.&quot;details&quot;, &quot;events_event&quot;.&quot;years_ago&quot;</span>
<span class="go">    FROM &quot;events_event&quot;</span>
</pre></div>
</div>
<img alt="_images/sql_query.png" src="_images/sql_query.png" />
<p>두 번째 예제</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">years_ago__gt</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<span class="go">SELECT &quot;events_event&quot;.&quot;id&quot;, &quot;events_event&quot;.&quot;epic_id&quot;, &quot;events_event&quot;.&quot;details&quot;,</span>
<span class="go">&quot;events_event&quot;.&quot;years_ago&quot; FROM &quot;events_event&quot;</span>
<span class="go">WHERE &quot;events_event&quot;.&quot;years_ago&quot; &gt; 5</span>
</pre></div>
</div>
</div>
<span id="document-or_query"></span><div class="section" id="or">
<h3>OR 연산으로 일부 조건을 하나라도 만족하는 항목을 구하려면 어떻게 하나요?<a class="headerlink" href="#or" title="Permalink to this headline">¶</a></h3>
<img alt="_images/usertable.png" src="_images/usertable.png" />
<p>장고의 사용자 계정 관리 앱인 <code class="code docutils literal notranslate"><span class="pre">django.contrib.auth</span></code> 를 사용하면 데이터베이스에 <code class="code docutils literal notranslate"><span class="pre">auth_user</span></code> 라는 표가 생성됩니다. 이 표에는 <code class="code docutils literal notranslate"><span class="pre">username</span></code>, <code class="code docutils literal notranslate"><span class="pre">first_name</span></code>, <code class="code docutils literal notranslate"><span class="pre">last_name</span></code> 등의 열이 있습니다.</p>
<p><code class="code docutils literal notranslate"><span class="pre">OR</span></code> 연산으로 여러 조건 중 하나라도 만족하는 행을 구해야 하는 경우가 많습니다. 이름이 ‘R’로 시작하거나 성이 ‘D’로 시작하는 모든 사용자를 구한다고 해 봅시다.</p>
<p>장고에서는 다음 두 방법으로 구할 수 있습니다.</p>
<ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">queryset_1</span> <span class="pre">|</span> <span class="pre">queryset_2</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">filter(Q(&lt;condition_1&gt;)|Q(&lt;condition_2&gt;))</span></code></li>
</ul>
<div class="section" id="id1">
<h4>질의문 살펴보기<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>위 조건의 SQL 질의문은 다음과 같이 생성됩니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">username</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">email</span> <span class="n">FROM</span> <span class="n">auth_user</span> <span class="n">WHERE</span> <span class="n">first_name</span> <span class="n">LIKE</span> <span class="s1">&#39;R%&#39;</span> <span class="n">OR</span> <span class="n">last_name</span> <span class="n">LIKE</span> <span class="s1">&#39;D%&#39;</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/sqluser_result1.png" src="_images/sqluser_result1.png" />
<p>장고 ORM 코드도 비슷합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">first_name__startswith</span><span class="o">=</span><span class="s1">&#39;R&#39;</span>
    <span class="p">)</span> <span class="o">|</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">last_name__startswith</span><span class="o">=</span><span class="s1">&#39;D&#39;</span>
<span class="p">)</span>
<span class="n">queryset</span>
<span class="o">&lt;</span><span class="n">QuerySet</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">Ricky</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">Ritesh</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">Radha</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">Raghu</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">rishab</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>장고 ORM이 생성하는 SQL 질의문도 한 번 확인해 봅시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="nb">str</span><span class="p">(</span><span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="s1">&#39;SELECT &quot;auth_user&quot;.&quot;id&quot;, &quot;auth_user&quot;.&quot;password&quot;, &quot;auth_user&quot;.&quot;last_login&quot;,</span>
<span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;is_superuser&quot;</span><span class="p">,</span> <span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;first_name&quot;</span><span class="p">,</span>
<span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;last_name&quot;</span><span class="p">,</span> <span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;is_staff&quot;</span><span class="p">,</span>
<span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;is_active&quot;</span><span class="p">,</span> <span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;date_joined&quot;</span> <span class="n">FROM</span> <span class="s2">&quot;auth_user&quot;</span>
<span class="n">WHERE</span> <span class="p">(</span><span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;first_name&quot;</span><span class="p">::</span><span class="n">text</span> <span class="n">LIKE</span> <span class="n">R</span><span class="o">%</span> <span class="n">OR</span> <span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;last_name&quot;</span><span class="p">::</span><span class="n">text</span> <span class="n">LIKE</span> <span class="n">D</span><span class="o">%</span><span class="p">)</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">Q</span></code> 객체를 이용하는 방법도 가능합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">first_name__startswith</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">last_name__startswith</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>두 방법 모두 생성되는 SQL 질의문은 완전히 동일합니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>In [9]: str(qs.query)
Out[9]: &#39;SELECT &quot;auth_user&quot;.&quot;id&quot;, &quot;auth_user&quot;.&quot;password&quot;, &quot;auth_user&quot;.&quot;last_login&quot;,
 &quot;auth_user&quot;.&quot;is_superuser&quot;, &quot;auth_user&quot;.&quot;username&quot;, &quot;auth_user&quot;.&quot;first_name&quot;,
  &quot;auth_user&quot;.&quot;last_name&quot;, &quot;auth_user&quot;.&quot;email&quot;, &quot;auth_user&quot;.&quot;is_staff&quot;,
  &quot;auth_user&quot;.&quot;is_active&quot;, &quot;auth_user&quot;.&quot;date_joined&quot; FROM &quot;auth_user&quot;
  WHERE (&quot;auth_user&quot;.&quot;first_name&quot;::text LIKE R% OR &quot;auth_user&quot;.&quot;last_name&quot;::text LIKE D%)&#39;
</pre></div>
</div>
</div>
</div>
<span id="document-and_query"></span><div class="section" id="and">
<h3>AND 연산으로 여러 조건을 모두 만족하는 항목을 구하려면 어떻게 하나요?<a class="headerlink" href="#and" title="Permalink to this headline">¶</a></h3>
<img alt="_images/usertable.png" src="_images/usertable.png" />
<p>장고의 사용자 계정 관리 앱인 <code class="code docutils literal notranslate"><span class="pre">django.contrib.auth</span></code> 를 사용하면 데이터베이스에 <code class="code docutils literal notranslate"><span class="pre">auth_user</span></code> 라는 표가 생성됩니다. 이 표에는 <code class="code docutils literal notranslate"><span class="pre">username</span></code>, <code class="code docutils literal notranslate"><span class="pre">first_name</span></code>, <code class="code docutils literal notranslate"><span class="pre">last_name</span></code> 등의 열이 있습니다.</p>
<p><code class="code docutils literal notranslate"><span class="pre">AND</span></code> 연산으로 여러 조건을 모두 만족하는 행을 구해야 하는 경우가 많습니다. 이름이 ‘R’로 시작하고 성이 ‘D’로 시작하는 모든 사용자를 구한다고 해 봅시다.</p>
<p>장고에서는 다음 세 방법으로 구할 수 있습니다.</p>
<ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">filter(&lt;condition_1&gt;,</span> <span class="pre">&lt;condition_2&gt;)</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">queryset_1</span> <span class="pre">&amp;</span> <span class="pre">queryset_2</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">filter(Q(&lt;condition_1&gt;)</span> <span class="pre">&amp;</span> <span class="pre">Q(&lt;condition_2&gt;))</span></code></li>
</ul>
<div class="section" id="id1">
<h4>질의문 살펴보기<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>위 조건의 SQL 질의문은 다음과 같이 생성됩니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">username</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">email</span> <span class="n">FROM</span> <span class="n">auth_user</span> <span class="n">WHERE</span> <span class="n">first_name</span> <span class="n">LIKE</span> <span class="s1">&#39;R%&#39;</span> <span class="n">AND</span> <span class="n">last_name</span> <span class="n">LIKE</span> <span class="s1">&#39;D%&#39;</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/sqluser_result2.png" src="_images/sqluser_result2.png" />
<p>장고 쿼리셋의 <code class="code docutils literal notranslate"><span class="pre">filter</span></code> 메서드에서 여러 조건을 결합하는 방법은 기본적으로 <code class="code docutils literal notranslate"><span class="pre">AND</span></code> 방식입니다. 따라서 다음과 같이 조건을 그냥 나열하면 됩니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">queryset_1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">first_name__startswith</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">,</span>
    <span class="n">last_name__startswith</span><span class="o">=</span><span class="s1">&#39;D&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>하지만 <cite>&amp;</cite> 연산자를 사용하여 쿼리셋을 명시적으로 결합할 수도 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">queryset_2</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">first_name__startswith</span><span class="o">=</span><span class="s1">&#39;R&#39;</span>
<span class="p">)</span> <span class="o">&amp;</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">last_name__startswith</span><span class="o">=</span><span class="s1">&#39;D&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>복잡한 질의를 수행할 수 있도록 도와주는 <code class="code docutils literal notranslate"><span class="pre">Q</span></code> 객체를 이용하여 조건을 명시해도 됩니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">queryset_3</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">Q</span><span class="p">(</span><span class="n">first_name__startswith</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="n">Q</span><span class="p">(</span><span class="n">last_name__startswith</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="p">)</span>


<span class="n">queryset_1</span>
<span class="o">&lt;</span><span class="n">QuerySet</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">Ricky</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">Ritesh</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">rishab</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>언제나 실제로 생성되는 SQL 질의문을 확인하여 검증하는 것이 도움이 됩니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>In [10]: str(queryset_2.query)
Out[10]: &#39;SELECT &quot;auth_user&quot;.&quot;id&quot;, &quot;auth_user&quot;.&quot;password&quot;, &quot;auth_user&quot;.&quot;last_login&quot;, &quot;auth_user&quot;.&quot;is_superuser&quot;, &quot;auth_user&quot;.&quot;username&quot;, &quot;auth_user&quot;.&quot;first_name&quot;, &quot;auth_user&quot;.&quot;last_name&quot;, &quot;auth_user&quot;.&quot;email&quot;, &quot;auth_user&quot;.&quot;is_staff&quot;, &quot;auth_user&quot;.&quot;is_active&quot;, &quot;auth_user&quot;.&quot;date_joined&quot; FROM &quot;auth_user&quot; WHERE (&quot;auth_user&quot;.&quot;first_name&quot;::text LIKE R% AND &quot;auth_user&quot;.&quot;last_name&quot;::text LIKE D%)&#39;

In [11]: str(queryset_1.query) == str(queryset_2.query) == str(queryset_3.query)
Out[11]: True
</pre></div>
</div>
</div>
</div>
<span id="document-notequal_query"></span><div class="section" id="not">
<h3>NOT 연산으로 조건을 부정하려면 어떻게 하나요?<a class="headerlink" href="#not" title="Permalink to this headline">¶</a></h3>
<img alt="_images/usertable.png" src="_images/usertable.png" />
<p>장고의 사용자 계정 관리 앱인 <code class="code docutils literal notranslate"><span class="pre">django.contrib.auth</span></code> 를 사용하면 데이터베이스에 <code class="code docutils literal notranslate"><span class="pre">auth_user</span></code> 라는 표가 생성됩니다. 이 표에는 <code class="code docutils literal notranslate"><span class="pre">username</span></code>, <code class="code docutils literal notranslate"><span class="pre">first_name</span></code>, <code class="code docutils literal notranslate"><span class="pre">last_name</span></code> 등의 열이 있습니다.</p>
<p>id &lt; 5 라는 조건을 만족하지 않는 모든 사용자를 구해 봅시다. 이를 수행하려면 NOT 연산이 필요합니다.</p>
<p>장고에서는 다음 두 방법으로 구할 수 있습니다.</p>
<ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">exclude(&lt;condition&gt;)</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">filter(~Q(&lt;condition&gt;))</span></code></li>
</ul>
<div class="section" id="id1">
<h4>질의문 살펴보기<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>위 조건의 SQL 질의문은 다음과 같이 생성됩니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="nb">id</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">email</span> <span class="n">FROM</span> <span class="n">auth_user</span> <span class="n">WHERE</span> <span class="n">NOT</span> <span class="nb">id</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span>
</pre></div>
</div>
<img alt="_images/sqluser_notquery.png" src="_images/sqluser_notquery.png" />
<p>exclude 메서드를 이용하는 방법은 다음과 같습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">id__lt</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queryset</span>
<span class="go">&lt;QuerySet [&lt;User: Ritesh&gt;, &lt;User: Billy&gt;, &lt;User: Radha&gt;, &lt;User: sohan&gt;, &lt;User: Raghu&gt;, &lt;User: rishab&gt;]&gt;</span>
</pre></div>
</div>
<p>Q 객체를 이용하는 방법은 다음과 같습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Q</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">id__lt</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queryst</span>
<span class="go">&lt;QuerySet [&lt;User: Ritesh&gt;, &lt;User: Billy&gt;, &lt;User: Radha&gt;, &lt;User: sohan&gt;, &lt;User: Raghu&gt;, &lt;User: rishab&gt;]&gt;</span>
</pre></div>
</div>
</div>
</div>
<span id="document-union"></span><div class="section" id="id1">
<h3>동일한 모델 또는 서로 다른 모델에서 구한 쿼리셋들을 합할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>SQL에서는 여러 개의 결과 집합을 합할 때 UNION 연산을 이용합니다. 장고 ORM에서 union 메서드를 이용해 쿼리셋을 합할 수 있습니다. 합하려는 쿼리셋의 모델이 서로 다른 경우, 각 쿼리셋에 포함된 필드와 데이터 유형이 서로 맞아야 합니다.</p>
<p><code class="code docutils literal notranslate"><span class="pre">auth_user</span></code> 모델에서 두 쿼리셋을 구한 뒤 합집합을 구해 봅시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">q1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__gte</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q1</span>
<span class="go">&lt;QuerySet [&lt;User: Ritesh&gt;, &lt;User: Billy&gt;, &lt;User: Radha&gt;, &lt;User: sohan&gt;, &lt;User: Raghu&gt;, &lt;User: rishab&gt;]&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q2</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__lte</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q2</span>
<span class="go">&lt;QuerySet [&lt;User: yash&gt;, &lt;User: John&gt;, &lt;User: Ricky&gt;, &lt;User: sharukh&gt;, &lt;User: Ritesh&gt;, &lt;User: Billy&gt;, &lt;User: Radha&gt;, &lt;User: sohan&gt;, &lt;User: Raghu&gt;]&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span>
<span class="go">&lt;QuerySet [&lt;User: yash&gt;, &lt;User: John&gt;, &lt;User: Ricky&gt;, &lt;User: sharukh&gt;, &lt;User: Ritesh&gt;, &lt;User: Billy&gt;, &lt;User: Radha&gt;, &lt;User: sohan&gt;, &lt;User: Raghu&gt;, &lt;User: rishab&gt;]&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q2</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
<span class="go">&lt;QuerySet [&lt;User: yash&gt;, &lt;User: John&gt;, &lt;User: Ricky&gt;, &lt;User: sharukh&gt;, &lt;User: Ritesh&gt;, &lt;User: Billy&gt;, &lt;User: Radha&gt;, &lt;User: sohan&gt;, &lt;User: Raghu&gt;, &lt;User: rishab&gt;]&gt;</span>
</pre></div>
</div>
<p>다음 코드는 실행하면 오류가 발생합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">q3</span> <span class="o">=</span> <span class="n">EventVillain</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q3</span>
<span class="go">&lt;QuerySet [&lt;EventVillain: EventVillain object (1)&gt;]&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">q1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span>
<span class="go">django.db.utils.OperationalError: SELECTs to the left and right of UNION do not have the same number of result columns</span>
</pre></div>
</div>
<p>union 메서드는 합하려는 쿼리셋의 필드와 데이터 유형이 서로 일치할 때만 실행할 수 있습니다. 그래서 마지막 명령이 실패했습니다.</p>
<p><code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 모델과 <code class="code docutils literal notranslate"><span class="pre">Villain</span></code> 모델은 둘 다 <code class="code docutils literal notranslate"><span class="pre">name</span></code> 필드와 <code class="code docutils literal notranslate"><span class="pre">gender</span></code> 필드를 갖고 있습니다. <code class="code docutils literal notranslate"><span class="pre">values_list</span></code> 를 이용해 공통된 필드만 가져온 뒤 union을 수행할 수 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
    <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
<span class="n">Villain</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
    <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span>
<span class="p">))</span>
</pre></div>
</div>
<p>위 코드를 실행하면 <code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 모델과 <code class="code docutils literal notranslate"><span class="pre">Villain</span></code> 모델의 이름과 성별을 구할 수 있습니다.</p>
</div>
<span id="document-select_some_fields"></span><div class="section" id="id1">
<h3>필요한 열만 골라 조회하려면 어떻게 하나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<img alt="_images/usertable.png" src="_images/usertable.png" />
<p><code class="code docutils literal notranslate"><span class="pre">auth_user</span></code> 모델에는 여러 개의 필드가 정의되어 있습니다. 그런데 이 필드가 전부 다 필요하지 않을 때도 있죠. 그럴 때 필요한 열만을 데이터베이스에서 읽어오는 방법을 알아 봅시다.</p>
<p>장고는 두 가지 방법을 제공합니다.</p>
<ul class="simple">
<li>쿼리셋의 <code class="code docutils literal notranslate"><span class="pre">values</span></code> 메서드와 <code class="code docutils literal notranslate"><span class="pre">values_list</span></code> 메서드</li>
<li><code class="code docutils literal notranslate"><span class="pre">only</span></code> 메서드</li>
</ul>
<p>이름이 R로 시작하는 모든 사용자의 이름(<code class="code docutils literal notranslate"><span class="pre">first_name</span></code>)과 성(<code class="code docutils literal notranslate"><span class="pre">last_name</span></code>)을 구해 봅시다. 데이터베이스 시스템의 부하를 줄이기 위해 그 외의 열은 가져오지 않겠습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="go">    first_name__startswith=&#39;R&#39;</span>
<span class="go">).values(&#39;first_name&#39;, &#39;last_name&#39;)</span>
<span class="go">&lt;QuerySet [{&#39;first_name&#39;: &#39;Ricky&#39;, &#39;last_name&#39;: &#39;Dayal&#39;}, {&#39;first_name&#39;: &#39;Ritesh&#39;, &#39;last_name&#39;: &#39;Deshmukh&#39;}, {&#39;first_name&#39;: &#39;Radha&#39;, &#39;last_name&#39;: &#39;George&#39;}, {&#39;first_name&#39;: &#39;Raghu&#39;, &#39;last_name&#39;: &#39;Khan&#39;}, {&#39;first_name&#39;: &#39;Rishabh&#39;, &#39;last_name&#39;: &#39;Deol&#39;}]</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">str(queryset.query)</span></code> 으로 실제로 실행되는 SQL 질의문을 확인할 수 있습니다. 다음과 같은 질의문이 실행되었습니다.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;first_name&quot;</span><span class="p">,</span> <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;last_name&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;auth_user&quot;</span> <span class="k">WHERE</span> <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;first_name&quot;</span><span class="p">::</span><span class="nb">text</span> <span class="k">LIKE</span> <span class="n">R</span><span class="o">%</span>
</pre></div>
</div>
<p>실행 결과는 사전의 리스트입니다.</p>
<p>한편, only 메서드를 사용할 수도 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">first_name__startswith</span><span class="o">=</span><span class="s1">&#39;R&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s2">&quot;first_name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_name&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">str(queryset.query)</span></code> 로 SQL 질의문을 확인해 봅시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;first_name&quot;</span><span class="p">,</span> <span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;last_name&quot;</span>
<span class="n">FROM</span> <span class="s2">&quot;auth_user&quot;</span> <span class="n">WHERE</span> <span class="s2">&quot;auth_user&quot;</span><span class="o">.</span><span class="s2">&quot;first_name&quot;</span><span class="p">::</span><span class="n">text</span> <span class="n">LIKE</span> <span class="n">R</span><span class="o">%</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">only</span></code> 메서드가 <code class="code docutils literal notranslate"><span class="pre">values</span></code> 메서드와 다른 점은 <code class="code docutils literal notranslate"><span class="pre">id</span></code> 필드를 함께 가져온다는 점 뿐입니다.</p>
</div>
<span id="document-subquery"></span><div class="section" id="id1">
<h3>장고에서 서브쿼리 식을 사용할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>장고에서 SQL 서브쿼리(subquery, 질의문 내의 하위 질의) 식을 사용할 수 있습니다. 간단한 것부터 시작해 봅시다. <code class="code docutils literal notranslate"><span class="pre">auth_user</span></code> 모델과 일 대 일(<code class="code docutils literal notranslate"><span class="pre">OneToOne</span></code>) 관계로 연결된 <code class="code docutils literal notranslate"><span class="pre">UserParent</span></code> 모델이 있다고 합시다. 아래 코드로 <code class="code docutils literal notranslate"><span class="pre">UserParent</span></code> 모델에서 <code class="code docutils literal notranslate"><span class="pre">auth_user</span></code> 를 가진 행을 모두 구할 수 있습니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; from django.db.models import Subquery
&gt;&gt;&gt; users = User.objects.all()
&gt;&gt;&gt; UserParent.objects.filter(user_id__in=Subquery(users.values(&#39;id&#39;)))
&lt;QuerySet [&lt;UserParent: UserParent object (2)&gt;, &lt;UserParent: UserParent object (5)&gt;, &lt;UserParent: UserParent object (8)&gt;]&gt;
</pre></div>
</div>
<p>조금 더 까다로운 예제를 살펴봅시다. <code class="code docutils literal notranslate"><span class="pre">Category</span></code> 모델의 각 행 별로, 가장 선한 <code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 행을 구해 봅시다.</p>
<p>모델은 다음과 같이 준비합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Hero</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>

    <span class="n">benevolence_factor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;How benevolent this hero is?&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">50</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>이 모델에서 가장 선한 영웅을 구하려면 다음 코드를 실행합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hero_qs</span> <span class="o">=</span> <span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">category</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-benevolence_factor&quot;</span><span class="p">)</span>
<span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">most_benevolent_hero</span><span class="o">=</span><span class="n">Subquery</span><span class="p">(</span>
        <span class="n">hero_qs</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>이 코드가 실행하는 SQL 질의문은 다음과 같습니다.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;entities_category&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span>
       <span class="ss">&quot;entities_category&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span><span class="p">,</span>

  <span class="p">(</span><span class="k">SELECT</span> <span class="n">U0</span><span class="p">.</span><span class="ss">&quot;name&quot;</span>
   <span class="k">FROM</span> <span class="ss">&quot;entities_hero&quot;</span> <span class="n">U0</span>
   <span class="k">WHERE</span> <span class="n">U0</span><span class="p">.</span><span class="ss">&quot;category_id&quot;</span> <span class="o">=</span> <span class="p">(</span><span class="ss">&quot;entities_category&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">)</span>
   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">U0</span><span class="p">.</span><span class="ss">&quot;benevolence_factor&quot;</span> <span class="k">DESC</span>
   <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;most_benevolent_hero&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;entities_category&quot;</span>
</pre></div>
</div>
<p>질의문을 한 단계씩 나누어 살펴봅시다. 다음 코드가 첫 번째 단계입니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hero_qs</span> <span class="o">=</span> <span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">category</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-benevolence_factor&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 모델의 항목들을 선함(<code class="code docutils literal notranslate"><span class="pre">benevolence_factor</span></code>)에 따라 내림차순으로 정렬하여 선택합니다. 그리고 <code class="code docutils literal notranslate"><span class="pre">category=OuterRef(&quot;pk&quot;)</span></code> 를 이용해 이 선택이 서브쿼리로 사용될 수 있도록 준비합니다.</p>
<p>그 뒤 <code class="code docutils literal notranslate"><span class="pre">most_benevolent_hero=Subquery(hero_qs.values('name')[:1])</span></code> 로 서브쿼리에 별칭을 붙여 <code class="code docutils literal notranslate"><span class="pre">Category</span></code> 쿼리셋 안에서 사용합니다. 이 때, <code class="code docutils literal notranslate"><span class="pre">hero_qs.values('name')[:1]</span></code> 는 서브쿼리에서 첫 번째 행의 name 필드를 구하는 코드입니다.</p>
</div>
<span id="document-f_query"></span><div class="section" id="id1">
<h3>필드의 값을 서로 비교하여 항목을 선택할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>장고 ORM에서 필드를 고정 값과 비교하여 항목을 선택하는 것은 간단합니다. 예를 들어, 이름(<code class="code docutils literal notranslate"><span class="pre">first_name</span></code>) 이 <code class="code docutils literal notranslate"><span class="pre">'R'</span></code> 로 시작하는 <code class="code docutils literal notranslate"><span class="pre">User</span></code> 모델의 행을 구하려면
<code class="code docutils literal notranslate"><span class="pre">User.objects.filter(first_name__startswith='R')</span></code> 와 같이 코드를 작성하면 됩니다.</p>
<p>그런데 필드와 필드를 서로 비교할 수도 있을까요? 예를 들어, 이름(<code class="code docutils literal notranslate"><span class="pre">first_name</span></code>) 을 성(<code class="code docutils literal notranslate"><span class="pre">last_name</span></code>) 과 비교하여 선택하는 것이죠. 이럴 때 <code class="code docutils literal notranslate"><span class="pre">F</span></code> 객체를 사용합니다.</p>
<p>실습을 위해 <code class="code docutils literal notranslate"><span class="pre">User</span></code> 모델의 항목을 몇 개 생성합시다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>In [27]: User.objects.create_user(email=&quot;shabda@example.com&quot;, username=&quot;shabda&quot;, first_name=&quot;Shabda&quot;, last_name=&quot;Raaj&quot;)
Out[27]: &lt;User: shabda&gt;

In [28]: User.objects.create_user(email=&quot;guido@example.com&quot;, username=&quot;Guido&quot;, first_name=&quot;Guido&quot;, last_name=&quot;Guido&quot;)
Out[28]: &lt;User: Guido&gt;
</pre></div>
</div>
<p>실습 데이터가 준비되었으면, 다음 코드로 이름과 성이 동일한 사용자를 구해 봅시다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>In [29]: User.objects.filter(last_name=F(&quot;first_name&quot;))
Out[29]: &lt;QuerySet [&lt;User: Guido&gt;]&gt;
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">F</span></code> 객체는 annotate 메서드로 계산해 둔 필드를 가리킬 때도 사용할 수 있습니다. 예를 들어, 이름의 첫 글자와 성의 첫 글자가 동일한 사용자를 구하고 싶다면  <code class="code docutils literal notranslate"><span class="pre">Substr(&quot;first_name&quot;,</span> <span class="pre">1,</span> <span class="pre">1)</span></code> 를 사용할 수 있습니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>In [41]: User.objects.create_user(email=&quot;guido@example.com&quot;, username=&quot;Tim&quot;, first_name=&quot;Tim&quot;, last_name=&quot;Teters&quot;)
Out[41]: &lt;User: Tim&gt;
#...
In [46]: User.objects.annotate(first=Substr(&quot;first_name&quot;, 1, 1), last=Substr(&quot;last_name&quot;, 1, 1)).filter(first=F(&quot;last&quot;))
Out[46]: &lt;QuerySet [&lt;User: Guido&gt;, &lt;User: Tim&gt;]&gt;
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">F</span></code> 객체에 <code class="code docutils literal notranslate"><span class="pre">__gt</span></code>, <code class="code docutils literal notranslate"><span class="pre">__lt</span></code> 등의 룩업(lookup)을 적용하는 것 또한 가능합니다.</p>
</div>
<span id="document-filefield"></span><div class="section" id="filefield">
<h3>FileField에 파일이 들어있지 않은 행은 어떻게 구할 수 있나요?<a class="headerlink" href="#filefield" title="Permalink to this headline">¶</a></h3>
<p>장고의 <code class="code docutils literal notranslate"><span class="pre">FileField</span></code> 와 <code class="code docutils literal notranslate"><span class="pre">ImageField</span></code> 는 파일과 이미지 파일의 경로를 저장합니다. 이것은 응용 수준에서의 구별이고, 데이터베이스 수준에서는 모두 <code class="code docutils literal notranslate"><span class="pre">CharField</span></code> 와 동일한 방식으로 저장됩니다. 파일이 없는 행을 구하려면 다음 코드를 실행하면 됩니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">no_files_objects</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">Q</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<span id="document-join"></span><div class="section" id="join">
<h3>두 모델을 결합(JOIN)하려면 어떻게 하나요?<a class="headerlink" href="#join" title="Permalink to this headline">¶</a></h3>
<p>SQL에서는 JOIN 문을 이용해 동일한 값을 가진 열을 기준으로 두 표를 결합할 수 있습니다. 결합 연산은 여러 가지 방법으로 수행할 수 있습니다. 다음은 장고에서 이를 수행하는 몇 가지 예입니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;reporter&#39;</span><span class="p">)</span> <span class="o">//</span> <span class="n">Using</span> <span class="n">select_related</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span>
<span class="go">&lt;QuerySet [&lt;Article: International News&gt;, &lt;Article: Local News&gt;, &lt;Article: Morning news&gt;, &lt;Article: Prime time&gt;, &lt;Article: Test Article&gt;, &lt;Article: Weather Report&gt;]&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<span class="go">SELECT &quot;events_article&quot;.&quot;id&quot;, &quot;events_article&quot;.&quot;headline&quot;, &quot;events_article&quot;.&quot;pub_date&quot;, &quot;events_article&quot;.&quot;reporter_id&quot;, &quot;events_article&quot;.&quot;slug&quot;, &quot;auth_user&quot;.&quot;id&quot;, &quot;auth_user&quot;.&quot;password&quot;, &quot;auth_user&quot;.&quot;last_login&quot;, &quot;auth_user&quot;.&quot;is_superuser&quot;, &quot;auth_user&quot;.&quot;username&quot;, &quot;auth_user&quot;.&quot;first_name&quot;, &quot;auth_user&quot;.&quot;last_name&quot;, &quot;auth_user&quot;.&quot;email&quot;, &quot;auth_user&quot;.&quot;is_staff&quot;, &quot;auth_user&quot;.&quot;is_active&quot;, &quot;auth_user&quot;.&quot;date_joined&quot; FROM &quot;events_article&quot; INNER JOIN &quot;auth_user&quot; ON (&quot;events_article&quot;.&quot;reporter_id&quot; = &quot;auth_user&quot;.&quot;id&quot;) ORDER BY &quot;events_article&quot;.&quot;headline&quot; ASC</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a2</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">reporter__username</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a2</span>
<span class="go">&lt;QuerySet [&lt;Article: International News&gt;, &lt;Article: Local News&gt;, &lt;Article: Prime time&gt;, &lt;Article: Test Article&gt;, &lt;Article: Weather Report&gt;]&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">a2</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<span class="go">SELECT &quot;events_article&quot;.&quot;id&quot;, &quot;events_article&quot;.&quot;headline&quot;, &quot;events_article&quot;.&quot;pub_date&quot;, &quot;events_article&quot;.&quot;reporter_id&quot;, &quot;events_article&quot;.&quot;slug&quot; FROM &quot;events_article&quot; INNER JOIN &quot;auth_user&quot; ON (&quot;events_article&quot;.&quot;reporter_id&quot; = &quot;auth_user&quot;.&quot;id&quot;) WHERE &quot;auth_user&quot;.&quot;username&quot; = John ORDER BY &quot;events_article&quot;.&quot;headline&quot; ASC</span>
</pre></div>
</div>
</div>
<span id="document-second_largest"></span><div class="section" id="id1">
<h3>두번째로 큰 항목은 어떻게 구하죠?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>어떤 필드를 기준으로 데이터를 정렬했을 때, 두 번째 항목을 구해야 하는 경우가 있습니다. 예컨대, 나이·급여 등이 두번째로 많은 사용자를 찾아야 하는 경우가 있겠죠.</p>
<p>장고 ORM에서 첫번째 항목은 <code class="code docutils literal notranslate"><span class="pre">first()</span></code> 메서드로, 마지막 항목은 <code class="code docutils literal notranslate"><span class="pre">last()</span></code> 메서드로 구할 수 있습니다. 하지만 N번째 항목을 구하는 메서드는 제공되지 않습니다. 그 대신, 파이썬의 인덱싱 연산을 이용할 수 있습니다.</p>
<img alt="_images/usertable.png" src="_images/usertable.png" />
<p>아래 코드와 같이, 인덱싱 연산으로 정렬된 데이터의 N번째 항목을 구할 수 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-last_login&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">Second</span> <span class="n">Highest</span> <span class="n">record</span> <span class="n">w</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">t</span> <span class="s1">&#39;last_login&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span>
<span class="go">&#39;Raghu&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-last_login&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="n">Third</span> <span class="n">Highest</span> <span class="n">record</span> <span class="n">w</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">t</span> <span class="s1">&#39;last_login&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span>
<span class="go">&#39;Sohan&#39;</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">User.objects.order_by('-last_login')[2]</span></code> 와 같이 쿼리셋에 인덱스 연산을 지시할 때, 장고 ORM은 데이터베이스에서 전체 데이터를 가져온 뒤 인덱싱하는 것이 아니라, <code class="code docutils literal notranslate"><span class="pre">LIMIT</span> <span class="pre">...</span> <span class="pre">OFFSET</span></code> SQL 구문을 이용해 필요한 데이터만 읽어 옵니다. 실제로 생성되는 SQL 질의문을 살펴봅시다.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;password&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;last_login&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;is_superuser&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;first_name&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;last_name&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;email&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;is_staff&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;is_active&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;date_joined&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;auth_user&quot;</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;last_login&quot;</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">1</span>
<span class="k">OFFSET</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<span id="document-duplicate"></span><div class="section" id="id1">
<h3>특정 열의 값이 동일한 항목은 어떻게 찾나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<img alt="_images/usertable2.png" src="_images/usertable2.png" />
<p><code class="code docutils literal notranslate"><span class="pre">first_name</span></code> 이 서로 동일한 사용자들을 구한다고 합시다. 특정 열에서 중복된 값을 찾을 때는 아래와 같이 <code class="code docutils literal notranslate"><span class="pre">Count</span></code> 를 구한 뒤 중복 수를 기준으로 골라내면 됩니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">duplicates</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
<span class="go">    &#39;first_name&#39;</span>
<span class="go">    ).annotate(name_count=Count(&#39;first_name&#39;)).filter(name_count__gt=1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">duplicates</span>
<span class="go">&lt;QuerySet [{&#39;first_name&#39;: &#39;John&#39;, &#39;name_count&#39;: 3}]&gt;</span>
</pre></div>
</div>
<p>위와 같이 중복 값을 구했으면, 이 값을 가진 항목을 아래와 같이 구할 수 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">records</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">first_name__in</span><span class="o">=</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">([</span><span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">records</span><span class="p">])</span>
<span class="go">[2, 11, 13]</span>
</pre></div>
</div>
</div>
<span id="document-distinct"></span><div class="section" id="id1">
<h3>쿼리셋에서 고유한 필드 값을 가진 항목은 어떻게 구하나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<img alt="_images/usertable2.png" src="_images/usertable2.png" />
<p>이름이 다른 사용자와 겹치지 않은 사용자를 찾는다고 합시다. 다음과 같이 구할 수 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">distinct</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
    <span class="s1">&#39;first_name&#39;</span>
<span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">name_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;first_name&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">records</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">first_name__in</span><span class="o">=</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">distinct</span><span class="p">])</span>
</pre></div>
</div>
<p>한편, <code class="code docutils literal notranslate"><span class="pre">User.objects.distinct(&quot;first_name&quot;).all()</span></code> 와 같은 코드는 고유한 <code class="code docutils literal notranslate"><span class="pre">first_name</span></code> 을 가진 사용자별로 첫번째 사용자를 구하는 코드입니다. 위 코드와는 실행 결과가 다릅니다.</p>
</div>
<span id="document-query_relatedtool"></span><div class="section" id="q">
<h3>Q 객체를 이용해 복잡한 질의를 수행하는 방법은 무엇인가요?<a class="headerlink" href="#q" title="Permalink to this headline">¶</a></h3>
<p>앞선 몇 개의 장에서 <code class="code docutils literal notranslate"><span class="pre">Q</span></code> 객체를 이용해 <code class="code docutils literal notranslate"><span class="pre">OR</span></code> 연산, <code class="code docutils literal notranslate"><span class="pre">AND</span></code> 연산, <code class="code docutils literal notranslate"><span class="pre">NOT</span></code> 연산을 수행해 보았습니다. <code class="code docutils literal notranslate"><span class="pre">Q</span></code> 객체를 이용하면 SQL 질의문의 WHERE 절에 해당하는 기능을 온전히 활용할 수 있습니다.</p>
<p>조건식에서 <code class="code docutils literal notranslate"><span class="pre">OR</span></code> 연산을 수행하려면 다음과 같이 합니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; from django.db.models import Q
&gt;&gt;&gt; queryset = User.objects.filter(
    Q(first_name__startswith=&#39;R&#39;) | Q(last_name__startswith=&#39;D&#39;)
)
&gt;&gt;&gt; queryset
&lt;QuerySet [&lt;User: Ricky&gt;, &lt;User: Ritesh&gt;, &lt;User: Radha&gt;, &lt;User: Raghu&gt;, &lt;User: rishab&gt;]&gt;
</pre></div>
</div>
<p>조건식에서 <code class="code docutils literal notranslate"><span class="pre">AND</span></code> 연산을 수행하려면 다음과 같이 합니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; queryset = User.objects.filter(
    Q(first_name__startswith=&#39;R&#39;) &amp; Q(last_name__startswith=&#39;D&#39;)
)
&gt;&gt;&gt; queryset
&lt;QuerySet [&lt;User: Ricky&gt;, &lt;User: Ritesh&gt;, &lt;User: rishab&gt;]&gt;
</pre></div>
</div>
<p>이름(<code class="code docutils literal notranslate"><span class="pre">first_name</span></code>)이 ‘R’로 시작하되, 성(<code class="code docutils literal notranslate"><span class="pre">last_name</span></code>)에 ‘Z’가 포함되지 않은 사용자를 모두 구하려면 다음과 같이 조건을 작성하면 됩니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; queryset = User.objects.filter(
    Q(first_name__startswith=&#39;R&#39;) &amp; ~Q(last_name__startswith=&#39;Z&#39;)
)
</pre></div>
</div>
<p>위 코드로 생성되는 질의문은 다음과 같습니다.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;password&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;last_login&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;is_superuser&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;first_name&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;last_name&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;email&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;is_staff&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;is_active&quot;</span><span class="p">,</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;date_joined&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;auth_user&quot;</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;first_name&quot;</span><span class="p">::</span><span class="nb">text</span> <span class="k">LIKE</span> <span class="n">R</span><span class="o">%</span>
       <span class="k">AND</span> <span class="k">NOT</span> <span class="p">(</span><span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;last_name&quot;</span><span class="p">::</span><span class="nb">text</span> <span class="k">LIKE</span> <span class="n">Z</span><span class="o">%</span><span class="p">))</span>
</pre></div>
</div>
<p>Q 객체를 이용하면 이보다 더 복잡한 조건의 질의도 문제 없이 지시할 수 있습니다.</p>
</div>
<span id="document-aggregation"></span><div class="section" id="id1">
<h3>기록된 항목의 집계를 구할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>장고 ORM을 이용해 항목을 생성·조회·갱신·삭제할 수 있지만, 때로는 항목들의 집계값을 구하고 싶을 때가 있습니다. 장고 ORM에는 SQL의 일반적인 집계 기능을 수행하는 <code class="code docutils literal notranslate"><span class="pre">Max</span></code>, <code class="code docutils literal notranslate"><span class="pre">Min</span></code>, <code class="code docutils literal notranslate"><span class="pre">Avg</span></code>, <code class="code docutils literal notranslate"><span class="pre">Sum</span></code> 등의 함수가 있습니다. 다음은 이 집계 함수를 이용하는 예입니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">Max</span><span class="p">,</span> <span class="n">Min</span><span class="p">,</span> <span class="n">Sum</span><span class="p">,</span> <span class="n">Count</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Avg</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
<span class="go">{&#39;id__avg&#39;: 7.571428571428571}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Max</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
<span class="go">{&#39;id__max&#39;: 15}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Min</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
<span class="go">{&#39;id__min&#39;: 1}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
<span class="go">{&#39;id__sum&#39;: 106}</span>
</pre></div>
</div>
</div>
<span id="document-random"></span><div class="section" id="id1">
<h3>항목을 무작위로 뽑고 싶습니다. 효율적인 방법이 있을까요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">Category</span></code> 모델을 아래와 같이 정의했다고 합시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;Categories&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>저장된 <code class="code docutils literal notranslate"><span class="pre">Category</span></code> 항목 가운데 하나를 무작위로 구해야 합니다. 두 가지 방법을 살펴보겠습니다.</p>
<p>먼저 살펴볼 방법은 정직하고 이해하기 쉽습니다. <code class="code docutils literal notranslate"><span class="pre">order_by</span></code> 메서드로 항목들을 정렬할 때, 정렬 기준을 ‘무작위’로 지정하는 것입니다. 데이터를 무작위로 정렬하여 첫 번째 항목을 가져오면 무작위 항목을 구할 수 있습니다. 코드로 작성해 봅시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_random</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
<p>주의: 사용하는 데이터베이스 시스템에 따라 <code class="code docutils literal notranslate"><span class="pre">order_by('?')</span></code> 의 실행 비용이 비싸고 성능이 느릴 수 있습니다. 뒤이어 살펴볼 다른 방법과의 비교를 위해 <code class="code docutils literal notranslate"><span class="pre">Category</span></code> 표에 1백만 개의 항목을 추가해 두겠습니다. 명령행 인터페이스에서  <code class="code docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">dbshell</span></code> 를 실행하여 데이터베이스 셸을 열고, 아래 질의문을 실행하시면 실습에 필요한 항목을 준비할 수 있습니다.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">entities_category</span>
            <span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="p">(</span><span class="k">SELECT</span> <span class="n">Md5</span><span class="p">(</span><span class="n">Random</span><span class="p">()</span> <span class="p">::</span> <span class="nb">text</span><span class="p">)</span> <span class="k">AS</span> <span class="n">descr</span>
 <span class="k">FROM</span>   <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">));</span>
</pre></div>
</div>
<p>위 SQL 질의문을 자세히 이해할 필요는 없습니다. (1부터 1백만까지의 수열을 생성하고 난수에 MD5 해시를 적용한 값을 생성하여 데이터베이스에 저장합니다.)</p>
<p>두 번째 방법은 전체 표를 정렬하는 대신 저장된 항목의 마지막 ID를 이용하는 것입니다. 표에서 ID의 최대값을 구하고, 1과 마지막 ID 사이의 난수를 하나 생성합니다. ID가 이 난수와 동일한 항목을 구하면 됩니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Max</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">entities.models</span> <span class="kn">import</span> <span class="n">Category</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">random</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">get_random2</span><span class="p">():</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">max_id</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">max_id</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))[</span><span class="s1">&#39;max_id&#39;</span><span class="p">]</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">pk</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_id</span><span class="p">)</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">return</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
   <span class="o">...</span><span class="p">:</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">get_random2</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Category</span><span class="p">:</span> <span class="n">e2c3a10d3e9c46788833c4ece2a418e2</span><span class="o">&gt;</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">get_random2</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Category</span><span class="p">:</span> <span class="n">f164ad0c5bc8300b469d1c428a514cc1</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>이 방법은 항목을 삭제하거나 해서 ID가 중간에 비어있는 경우에는 쓸 수 없습니다. 그런 경우에는 유효한 값이 나올 때까지 반복하도록 하면 됩니다. 다음은 그 방식으로 위의 함수를 수정한 것입니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">get_random3</span><span class="p">():</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">max_id</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">max_id</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))[</span><span class="s1">&#39;max_id&#39;</span><span class="p">]</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
   <span class="o">...</span><span class="p">:</span>         <span class="n">pk</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_id</span><span class="p">)</span>
   <span class="o">...</span><span class="p">:</span>         <span class="n">category</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
   <span class="o">...</span><span class="p">:</span>         <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
   <span class="o">...</span><span class="p">:</span>             <span class="k">return</span> <span class="n">category</span>
   <span class="o">...</span><span class="p">:</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">get_random3</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Category</span><span class="p">:</span> <span class="mi">334</span><span class="n">aa9926bd65dc0f9dd4fc86ce42e75</span><span class="o">&gt;</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">get_random3</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Category</span><span class="p">:</span> <span class="mi">4092762909</span><span class="n">c2c034e90c3d2eb5a73447</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>삭제된 항목이 많지 않다면 위의 무한반복 구문 <code class="code docutils literal notranslate"><span class="pre">while</span> <span class="pre">True:</span></code> 는 금방 종료될 것입니다. 그러면 파이썬의 <code class="code docutils literal notranslate"><span class="pre">timeit</span></code> 을 이용해 두 방법의 성능 차이를 확인해 봅시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="n">get_random3</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="mf">0.20055226399563253</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="n">get_random</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="mf">56.92513192095794</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">get_random3</span></code> 이 <code class="code docutils literal notranslate"><span class="pre">get_random</span></code> 보다 283배 빠르게 실행되었습니다. 단, <code class="code docutils literal notranslate"><span class="pre">get_random</span></code> 은 언제나 이용할 수 있는 반면에, <code class="code docutils literal notranslate"><span class="pre">get_random3</span></code> 의 방법은 장고의 기본 ID 생성 방식(auto increment, 자동 증가)을 재정의한 경우나 삭제된 항목이 너무 많을 때에는 사용하기가 어려울 수 있습니다.</p>
</div>
<span id="document-func_expressions"></span><div class="section" id="id1">
<h3>장고가 지원하지 않는 데이터베이스 함수를 사용할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>장고에는 <code class="code docutils literal notranslate"><span class="pre">Lower</span></code>, <code class="code docutils literal notranslate"><span class="pre">Coalesce</span></code>, <code class="code docutils literal notranslate"><span class="pre">Max</span></code> 등의 데이터베이스 함수가 포함되어 있습니다. 하지만 장고가 데이터베이스가 지원하는 모든 함수를 제공하는 것은 아닙니다. 특히, 특정 데이터베이스 시스템의 전용 함수들은 제공되지 않습니다.</p>
<p>장고가 제공하지 않는 데이터베이스 함수를 실행하기 위해서는 장고의 <code class="code docutils literal notranslate"><span class="pre">Func</span></code> 객체를 사용하면 됩니다.</p>
<p>PostgreSQL에는 <code class="code docutils literal notranslate"><span class="pre">fuzzystrmatch</span></code> 확장 기능이 있습니다. 이 확장에는 텍스트 데이터의 유사도를 측정하기 위한 함수가 여러 가지 포함되어 있습니다. PostgreSQL 데이터베이스 셸에서 <code class="code docutils literal notranslate"><span class="pre">create</span> <span class="pre">extension</span> <span class="pre">fuzzystrmatch</span></code> 를 실행하여 이 확장을 설치하고 아래의 실습을 진행해 주세요.</p>
<p>레벤슈타인 치환 거리 알고리즘을 구현한 <code class="code docutils literal notranslate"><span class="pre">levenshtein</span></code> 함수를 이용해 보겠습니다. 실습에 사용할 Hero 모델의 항목을 여러 개 생성합시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Zeus&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A greek God&quot;</span><span class="p">,</span> <span class="n">benevolence_factor</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">category_id</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">origin_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ZeuX&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A greek God&quot;</span><span class="p">,</span> <span class="n">benevolence_factor</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">category_id</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">origin_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Xeus&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A greek God&quot;</span><span class="p">,</span> <span class="n">benevolence_factor</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">category_id</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">origin_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Poseidon&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A greek God&quot;</span><span class="p">,</span> <span class="n">benevolence_factor</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">category_id</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">origin_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>이제 <code class="code docutils literal notranslate"><span class="pre">name</span></code> 이 ‘Zeus’ 와 비슷한 <code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 항목들을 구해 봅시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Func</span><span class="p">,</span> <span class="n">F</span>
<span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">like_zeus</span><span class="o">=</span><span class="n">Func</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;levenshtein&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(function)s</span><span class="s2">(</span><span class="si">%(expressions)s</span><span class="s2">, &#39;Zeus&#39;)&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">like_zeus=Func(F('name'),</span> <span class="pre">function='levenshtein',</span> <span class="pre">template=&quot;%(function)s(%(expressions)s,</span> <span class="pre">'Zeus')&quot;)</span></code> 코드에서 <code class="code docutils literal notranslate"><span class="pre">Func</span></code> 객체를 세 개의 인자로 초기화하였습니다. 첫 번째 인자는 함수에 적용할 열, 두 번째 인자는 데이터베이스에서 실행할 함수의 이름, 세 번째 인자는 함수를 실행할 SQL 질의문의 템플릿입니다. 이 함수를 여러 번 재사용할 계획이라면 다음과 같이 클래스를 확장하여 정의해 두면 편리합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LevenshteinLikeZeus</span><span class="p">(</span><span class="n">Func</span><span class="p">):</span>
    <span class="n">function</span><span class="o">=</span><span class="s1">&#39;levenshtein&#39;</span>
    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(function)s</span><span class="s2">(</span><span class="si">%(expressions)s</span><span class="s2">, &#39;Zeus&#39;)&quot;</span>
</pre></div>
</div>
<p>이제 <code class="code docutils literal notranslate"><span class="pre">Hero.objects.annotate(like_zeus=LevenshteinLikeZeus(F(&quot;name&quot;)))</span></code> 와 같이 클래스를 이용할 수 있습니다.</p>
<p>이렇게 구한 레벤슈타인 거리를 기준으로 이름이 비슷한 항목을 선별할 수 있습니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>In [16]: Hero.objects.annotate(
    ...:         like_zeus=LevenshteinLikeZeus(F(&quot;name&quot;))
    ...:     ).filter(
    ...:         like_zeus__lt=2
    ...:     )
    ...:
Out[16]: &lt;QuerySet [&lt;Hero: Zeus&gt;, &lt;Hero: ZeuX&gt;, &lt;Hero: Xeus&gt;]&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id2">
<h2>항목을 생성·갱신·삭제하는 방법<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-multiple_objects"></span><div class="section" id="id1">
<h3>여러 개의 행을 한번에 생성하는 방법이 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>여러 개의 신규 객체를 한꺼번에 저장하고 싶은 경우가 있습니다. 예를 들어, 여러 개의 분류 항목을 단번에 생성하되, 데이터베이스에 질의를 여러 번 수행하지 않아야 한다고 합시다.
<code class="code docutils literal notranslate"><span class="pre">bulk_create</span></code> 메서드를 이용하면 여러 개의 신규 객체를 한 번에 저장할 수 있습니다.</p>
<p>다음 예를 살펴보세요.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; Category.objects.all().count()
2
&gt;&gt;&gt; Category.objects.bulk_create(
    [Category(name=&quot;God&quot;),
     Category(name=&quot;Demi God&quot;),
     Category(name=&quot;Mortal&quot;)]
)
[&lt;Category: God&gt;, &lt;Category: Demi God&gt;, &lt;Category: Mortal&gt;]
&gt;&gt;&gt; Category.objects.all().count()
5
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">bulk_create</span></code> 메서드는 저장되지 않은 객체들을 담은 리스트를 인자로 전달받습니다.</p>
</div>
<span id="document-copy"></span><div class="section" id="id1">
<h3>기존에 저장된 행을 복사해 새로 저장하는 방법은 무엇인가요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>장고 ORM에는 모델 인스턴스를 복사하는 내장 메서드가 없습니다. 하지만 모든 필드의 값을 복사하여 새 인스턴스를 만들고 새로 저장하는 것은 어렵지 않습니다.</p>
<p>모델 인스턴스를 저장할 때, <code class="code docutils literal notranslate"><span class="pre">pk</span></code> 필드 값이 <code class="code docutils literal notranslate"><span class="pre">None</span></code> 으로 지정되어 있으면 데이터베이스에 새 행으로 저장됩니다. <code class="code docutils literal notranslate"><span class="pre">pk</span></code> 외의 모든 필드 값은 그대로 복제됩니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>In [2]: Hero.objects.all().count()
Out[2]: 4

In [3]: hero = Hero.objects.first()

In [4]: hero.pk = None

In [5]: hero.save()

In [6]: Hero.objects.all().count()
Out[6]: 5
</pre></div>
</div>
</div>
<span id="document-singleton"></span><div class="section" id="id1">
<h3>특정 모델의 항목이 하나만 생성되도록 강제하는 방법이 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>특정 모델의 항목이 단 하나만 생성되도록 강제하고 싶을 때가 있습니다. 프로그램의 환경 설정 기록, 공유 자원에 대한 잠금 제어 등을 예로 들 수 있습니다.</p>
<p>다음은 <code class="code docutils literal notranslate"><span class="pre">Origin</span></code> 이라는 모델을 싱글턴(단일개체)으로 만드는 기법입니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Origin</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">pk</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>위 코드는 <code class="code docutils literal notranslate"><span class="pre">save</span></code> 메서드를 재정의하여 <code class="code docutils literal notranslate"><span class="pre">pk</span></code> 필드를 이미 존재하는 값으로 지정하도록 강제합니다. 이로써 객체가 이미 존재할 때 <code class="code docutils literal notranslate"><span class="pre">create</span></code> 메서드를 호출하는 경우 <code class="code docutils literal notranslate"><span class="pre">IntegrityError</span></code> 예외가 발생하도록 합니다.</p>
</div>
<span id="document-update_denormalized_fields"></span><div class="section" id="id1">
<h3>모델 인스턴스를 저장할 때, 다른 모델에 반정규화된 필드를 함께 갱신하는 방법이 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>모델을 다음과 같이 구성했다고 합시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">hero_count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>
    <span class="n">villain_count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;Categories&quot;</span>


<span class="k">class</span> <span class="nc">Hero</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="c1"># ...</span>


<span class="k">class</span> <span class="nc">Villain</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>Hero 모델과 Villain 모델의 항목을 새로 저장할 때, Category 모델의 <code class="code docutils literal notranslate"><span class="pre">hero_count</span></code> 필드와 <code class="code docutils literal notranslate"><span class="pre">villain_count</span></code> 필드를 갱신해야 합니다.</p>
<p>다음과 같이 Hero 모델과 Villain 모델의 <code class="code docutils literal notranslate"><span class="pre">save</span></code> 메서드를 재정의하면 됩니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hero</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hero_count</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;hero_count&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Villain</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">villain_count</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;villain_count&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>위 코드에서 <code class="code docutils literal notranslate"><span class="pre">self.category.hero_count</span> <span class="pre">+=</span> <span class="pre">1</span></code> 과 같이 인스턴스의 값을 수정하는 것이 아니라, <code class="code docutils literal notranslate"><span class="pre">update</span></code> 메서드로 데이터베이스의 갱신을 수행하도록 한 것을 확인하시기 바랍니다.</p>
<p>또 다른 방법으로, ‘시그널(신호)’이라는 기능을 이용하는 방법이 있습니다. 시그널을 이용하는 예를 살펴봅시다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">pre_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>

<span class="nd">@receiver</span><span class="p">(</span><span class="n">pre_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Hero</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="s2">&quot;update_hero_count&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_hero_count</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">hero</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">hero</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">hero</span><span class="o">.</span><span class="n">category_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hero_count</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;hero_count&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="nd">@receiver</span><span class="p">(</span><span class="n">pre_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Villain</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="s2">&quot;update_villain_count&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_villain_count</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">villain</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">villain</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
        <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">villain</span><span class="o">.</span><span class="n">category_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">villain_count</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;villain_count&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="save">
<h4><code class="code docutils literal notranslate"><span class="pre">save</span></code> 메서드 재정의 방법과 시그널의 비교<a class="headerlink" href="#save" title="Permalink to this headline">¶</a></h4>
<p><code class="code docutils literal notranslate"><span class="pre">save</span></code> 메서드를 재정의하는 방법과 시그널을 이용하는 방법 모두 사용할 수 있습니다. 어느 것을 사용하는 것이 좋을까요? 다음 규칙을 권해 드립니다.</p>
<ul class="simple">
<li>반정규화 필드에 영향을 끼치는 모델을 여러분이 통제할 수 있다면 <code class="code docutils literal notranslate"><span class="pre">save</span></code> 메서드를 재정의합니다.</li>
<li>반정규화 필드에 영향을 끼치는 모델을 여러분이 통제할 수 없다면(그 영향이 라이브러리 등에서 이루어진다면) 시그널을 이용합니다.</li>
</ul>
</div>
</div>
<span id="document-truncate"></span><div class="section" id="truncate">
<h3>TRUNCATE 문을 수행하는 방법이 있나요?<a class="headerlink" href="#truncate" title="Permalink to this headline">¶</a></h3>
<p>SQL의 TRUNCATE 문은 표에 저장된 모든 항목을 제거하는 명령입니다. 장고는 TRUNCATE 문을 실행하는 명령을 제공하지 않습니다. 하지만 <code class="code docutils literal notranslate"><span class="pre">delete</span></code> 메서드를 이용해 비슷한 결과를 얻을 수 있습니다.</p>
<p>다음 예를 보십시오.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="go">(7, {&#39;entity.Category&#39;: 7})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">0</span>
</pre></div>
</div>
<p>위 코드는 잘 동작합니다. 하지만 TRUNCATE 문이 아니라 <code class="code docutils literal notranslate"><span class="pre">DELETE</span> <span class="pre">FROM</span> <span class="pre">...</span></code> 과 같은 SQL 질의를 수행합니다. 삭제해야 하는 항목의 수가 매우 많은 경우 처리 속도가 느릴 수 있습니다. <code class="code docutils literal notranslate"><span class="pre">truncate</span></code> 명령이 필요하다면 다음과 같이 <code class="code docutils literal notranslate"><span class="pre">Category</span></code> 모델에 <code class="code docutils literal notranslate"><span class="pre">classmethod</span></code> 로 추가하면 됩니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;TRUNCATE TABLE &quot;{0}&quot; CASCADE&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">))</span>
</pre></div>
</div>
<p>이렇게 메서드를 정의해 두면 <code class="code docutils literal notranslate"><span class="pre">Category.truncate()</span></code> 를 실행하여 정말로 데이터베이스 시스템에 TRUNCATE 문을 질의할 수 있습니다.</p>
</div>
<span id="document-signals"></span><div class="section" id="id1">
<h3>모델 인스턴스가 생성·갱신될 때 발생하는 시그널에는 어떤 것이 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>장고의 시그널을 이용하면 모델 인스턴스의 생명주기에 따라 특정 코드가 실행되도록 예약해 둘 수 있습니다. 장고가 제공하는 시그널의 종류는 다음과 같습니다.</p>
<ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">pre_init</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">post_init</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">pre_save</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">post_save</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">pre_delete</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">post_delete</span></code></li>
</ul>
<p>이 가운데 <code class="code docutils literal notranslate"><span class="pre">pre_save</span></code> 와 <code class="code docutils literal notranslate"><span class="pre">post_save</span></code> 가 가장 많이 사용됩니다. 이 두 시그널을 좀 더 자세히 살펴봅시다.</p>
<div class="section" id="save">
<h4>시그널과 <code class="code docutils literal notranslate"><span class="pre">save</span></code> 메서드 재정의 비교<a class="headerlink" href="#save" title="Permalink to this headline">¶</a></h4>
<p>시그널을 이용하면 <code class="code docutils literal notranslate"><span class="pre">save</span></code> 메서드를 재정의하는 것과 비슷한 효과를 누릴 수 있습니다. 그래서 어느 것을 사용해야 할지 헷갈릴 수도 있는데요, 다음 규칙에 따르시기 바랍니다.</p>
<ul class="simple">
<li>다른 사람(외부 라이브러리 등)이 여러분 앱의 <code class="code docutils literal notranslate"><span class="pre">save</span></code> 메서드를 재정의·커스터마이즈하도록 허용하려면 직접 시그널을 발생시켜야 합니다.</li>
<li>여러분이 통제할 수 없는 앱의 <code class="code docutils literal notranslate"><span class="pre">save</span></code> 메서드가 호출될 때 원하는 코드가 실행되도록 하려면 <code class="code docutils literal notranslate"><span class="pre">post_save</span></code> 시그널 또는 <code class="code docutils literal notranslate"><span class="pre">pre_save</span></code> 시그널을 이용해야 합니다.</li>
<li>여러분이 통제할 수 있는 앱의 저장 방식을 손 볼 때는 <code class="code docutils literal notranslate"><span class="pre">save</span></code> 메서드를 재정의해야 합니다.</li>
</ul>
<p>다음은 <code class="code docutils literal notranslate"><span class="pre">UserToken</span></code> 모델의 예입니다. 이 모델은 사용자 인증 정보를 제공하는 역할을 하며, <code class="code docutils literal notranslate"><span class="pre">User</span></code> 가 생성될 때 함께 생성됩니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserToken</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
</div>
</div>
<span id="document-datetime"></span><div class="section" id="id1">
<h3>시간 정보를 다른 양식으로 변환하여 데이터베이스에 저장하려면 어떻게 해야 하나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>장고에서 시간을 나타내는 텍스트를 다른 양식의 텍스트로 변환하여 데이터베이스에 저장하는 방법은 여러 가지가 있습니다. 몇 가지만 소개하겠습니다.</p>
<p>“2018-03-11”이라는 시간 텍스트가 있는데, 이 양식으로는 데이터베이스에 저장할 수 없다고 가정합시다. 아래와 같이 장고의 dateparser 모듈이나 파이썬 표준 라이브러리를 이용하여 날짜 양식을 변환할 수 있습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">date_str</span> <span class="o">=</span> <span class="s2">&quot;2018-03-11&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.utils.dateparse</span> <span class="k">import</span> <span class="n">parse_date</span> <span class="o">//</span> <span class="n">Way</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">temp_date</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;String converted to date&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">temp_date</span><span class="p">,</span> <span class="n">reporter</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">pub_date</span>
<span class="go">datetime.date(2018, 3, 11)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span> <span class="o">//</span> <span class="n">Way</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">temp_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a2</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;String converted to date way 2&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">temp_date</span><span class="p">,</span> <span class="n">reporter</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a2</span><span class="o">.</span><span class="n">pub_date</span>
<span class="go">datetime.date(2018, 3, 11)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h2>조회 결과를 정렬하는 방법<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-asc_or_desc"></span><div class="section" id="id1">
<h3>쿼리셋을 오름차순/내림차순으로 정렬할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">order_by</span></code> 메서드로 쿼리셋을 정렬할 수 있습니다. 기준 필드를 지정해 오름차순 혹은 내림차순으로 정렬할 수 있습니다. 다음 코드를 살펴보세요.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; User.objects.all().order_by(&#39;date_joined&#39;)  # 오름차순
&lt;QuerySet [&lt;User: yash&gt;, &lt;User: John&gt;, &lt;User: Ricky&gt;, &lt;User: sharukh&gt;, &lt;User: Ritesh&gt;, &lt;User: Billy&gt;, &lt;User: Radha&gt;, &lt;User: Raghu&gt;, &lt;User: rishab&gt;, &lt;User: johny&gt;, &lt;User: paul&gt;, &lt;User: johny1&gt;, &lt;User: alien&gt;]&gt;
&gt;&gt;&gt; User.objects.all().order_by(&#39;-date_joined&#39;)  # 내림차순
&lt;QuerySet [&lt;User: alien&gt;, &lt;User: johny1&gt;, &lt;User: paul&gt;, &lt;User: johny&gt;, &lt;User: rishab&gt;, &lt;User: Raghu&gt;, &lt;User: Radha&gt;, &lt;User: Billy&gt;, &lt;User: Ritesh&gt;, &lt;User: sharukh&gt;, &lt;User: Ricky&gt;, &lt;User: John&gt;, &lt;User: yash&gt;]&gt;
</pre></div>
</div>
<p>기준 필드를 여러 개 지정할 수도 있습니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>User.objects.all().order_by(&#39;date_joined&#39;, &#39;-last_login&#39;)
</pre></div>
</div>
<p>SQL 질의문은 다음과 같습니다.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span>
       <span class="c1">-- More fields</span>
       <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;date_joined&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;auth_user&quot;</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;date_joined&quot;</span> <span class="k">ASC</span><span class="p">,</span>
         <span class="ss">&quot;auth_user&quot;</span><span class="p">.</span><span class="ss">&quot;last_login&quot;</span> <span class="k">DESC</span>
</pre></div>
</div>
</div>
<span id="document-case_insensitive"></span><div class="section" id="id1">
<h3>대문자·소문자를 구별하지 않고 정렬하려면 어떻게 하나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<img alt="_images/usertable2.png" src="_images/usertable2.png" />
<p><code class="code docutils literal notranslate"><span class="pre">order_by</span></code> 메서드로 쿼리셋을 정렬할 때, 텍스트 필드를 기준으로 하면 알파벳의 대문자·소문자를 구분하여 정렬이 수행됩니다. 다음 예에서 보듯, 대문자에 소문자보다 높은 우선순위가 부여됩니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; User.objects.all().order_by(&#39;username&#39;).values_list(&#39;username&#39;, flat=True)
&lt;QuerySet [&#39;Billy&#39;, &#39;John&#39;, &#39;Radha&#39;, &#39;Raghu&#39;, &#39;Ricky&#39;, &#39;Ritesh&#39;, &#39;johny&#39;, &#39;johny1&#39;, &#39;paul&#39;, &#39;rishab&#39;, &#39;sharukh&#39;, &#39;sohan&#39;, &#39;yash&#39;]&gt;
</pre></div>
</div>
<p>텍스트 필드에서 대문자·소문자를 구별하지 않고 정렬하려면 다음과 같이 <code class="code docutils literal notranslate"><span class="pre">Lower</span></code> 를 사용하면 됩니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; from django.db.models.functions import Lower
&gt;&gt;&gt; User.objects.all().order_by(Lower(&#39;username&#39;)).values_list(&#39;username&#39;, flat=True)
&lt;QuerySet [&#39;Billy&#39;, &#39;John&#39;, &#39;johny&#39;, &#39;johny1&#39;, &#39;paul&#39;, &#39;Radha&#39;, &#39;Raghu&#39;, &#39;Ricky&#39;, &#39;rishab&#39;, &#39;Ritesh&#39;, &#39;sharukh&#39;, &#39;sohan&#39;, &#39;yash&#39;]&gt;
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">annotate</span></code> 메서드로 <code class="code docutils literal notranslate"><span class="pre">Lower</span></code> 를 적용한 열을 준비하고, 그 열을 기준으로 정렬하는 방법도 가능합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">lower_name</span><span class="o">=</span><span class="n">Lower</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;lower_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<span id="document-order_by_two"></span><div class="section" id="id1">
<h3>여러 개의 필드를 기준으로 정렬하는 방법이 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>쿼리셋의 <code class="code docutils literal notranslate"><span class="pre">order_by</span></code> 메서드에 여러 개의 정렬 기준 필드를 인자로 전달할 수 있습니다. 그러면 여러 개의 필드를 기준으로 정렬이 수행됩니다.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span>In [5]: from django.contrib.auth.models import User

In [6]: User.objects.all().order_by(&quot;is_active&quot;, &quot;-last_login&quot;, &quot;first_name&quot;)
Out[6]: &lt;QuerySet [&lt;User: Guido&gt;, &lt;User: shabda&gt;, &lt;User: Tim&gt;]&gt;
</pre></div>
</div>
</div>
<span id="document-order_by_related_model"></span><div class="section" id="id1">
<h3>외래 키로 연결된 다른 표의 열을 기준으로 정렬할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">Category</span></code> 모델과 <code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 모델이 다음과 같이 외래 키(ForeignKey)로 연결되어 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Hero</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</pre></div>
</div>
<p>아래 코드는 <code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 모델의 쿼리셋을 category 필드 순으로 정렬하되, category가 같은 항목은 (<code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 의) name 필드 순으로 정렬합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
    <span class="s1">&#39;category__name&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">'category__name'</span></code> 인자에 이중 밑줄 기호(<code class="code docutils literal notranslate"><span class="pre">__</span></code> )를 사용한 것을 봐 주세요. 이중 밑줄 기호로 연결된 모델의 필드를 가리킬 수 있습니다.</p>
<p>SQL 질의문은 다음과 같이 생성됩니다.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;entities_hero&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span>
       <span class="ss">&quot;entities_hero&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span><span class="p">,</span>
       <span class="c1">-- more fields</span>
<span class="k">FROM</span> <span class="ss">&quot;entities_hero&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;entities_category&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;entities_hero&quot;</span><span class="p">.</span><span class="ss">&quot;category_id&quot;</span> <span class="o">=</span> <span class="ss">&quot;entities_category&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="ss">&quot;entities_category&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="k">ASC</span><span class="p">,</span>
         <span class="ss">&quot;entities_hero&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="k">ASC</span>
</pre></div>
</div>
</div>
<span id="document-order_by_annotated_field"></span><div class="section" id="id1">
<h3>계산 필드를 기준으로 정렬할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">Category</span></code> 모델과 <code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 모델이 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Hero</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">Category</span></code> 항목들을 각 <code class="code docutils literal notranslate"><span class="pre">Category</span></code> 항목에 속한 <code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 항목의 개수에 따라 정렬하고 싶다면, 다음과 같이 <code class="code docutils literal notranslate"><span class="pre">annotate</span></code> 메서드로 계산 필드를 준비하여 기준으로 삼을 수 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">hero_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;hero&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
    <span class="s2">&quot;-hero_count&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id4">
<h2>모델을 정의하는 방법<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-one_to_one"></span><div class="section" id="id1">
<h3>일대일 관계는 어떻게 나타내나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>일대일 관계란 두 표에서 각 항목이 서로 다른 표의 항목 단 하나와 연결되는 관계입니다. 우리가 쉽게 이해할 수 있는 예를 들자면, 우리들 각자는 생부와 생모를 각각 하나씩만 가질 수 있습니다.</p>
<p>다음 예는 장고의 사용자 인증 모델에 <code class="code docutils literal notranslate"><span class="pre">UserParent</span></code> 모델을 일대일 관계로 연결해서 각 사용자마다 사용자의 부모를 기록할 수 있도록 합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="k">class</span> <span class="nc">UserParent</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="n">User</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
        <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">father_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">mother_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Ritesh&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;Deshmukh&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Sohan&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;Upadhyay&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p1</span> <span class="o">=</span> <span class="n">UserParent</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">u1</span><span class="p">,</span> <span class="n">father_name</span><span class="o">=</span><span class="s1">&#39;Vilasrao Deshmukh&#39;</span><span class="p">,</span> <span class="n">mother_name</span><span class="o">=</span><span class="s1">&#39;Vaishali Deshmukh&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p1</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span>
<span class="go">&#39;Ritesh&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p2</span> <span class="o">=</span> <span class="n">UserParent</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">u2</span><span class="p">,</span> <span class="n">father_name</span><span class="o">=</span><span class="s1">&#39;Mr R S Upadhyay&#39;</span><span class="p">,</span> <span class="n">mother_name</span><span class="o">=</span><span class="s1">&#39;Mrs S K Upadhyay&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p2</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span>
<span class="go">&#39;Upadhyay&#39;</span>
</pre></div>
</div>
<p>on_delete 메서드는 그 필드에 연결된 항목이 삭제될 때 그 항목을 가리키는 항목들을 어떻게 처리해야 할지 설정합니다. 예를 들어, <code class="code docutils literal notranslate"><span class="pre">on_delete=models.CASCADE</span></code> (하위 삭제)는 연결된 항목이 삭제될 때 해당 항목을 함께 삭제하도록 합니다. 따라서, 아래의 코드를 실행하면 <code class="code docutils literal notranslate"><span class="pre">User</span></code> 모델의 항목(u2) 뿐 아니라 <code class="code docutils literal notranslate"><span class="pre">UserParent</span></code> 의 항목(p2)도 함께 삭제됩니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</div>
<span id="document-one_to_many"></span><div class="section" id="id1">
<h3>일대다 관계는 어떻게 나타내나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>일대다 관계란 한 표의 상위 항목이 다른 표의 여러 하위 항목에서 참조되는 관계입니다. 일대다 관계에서 상위 항목이 반드시 하위 항목을 가진다는 보장은 없습니다. 상위 항목은 하위 항목을 0개, 1개, 여러 개 가질 수 있습니다.</p>
<p>장고 모델에서 일대다 관계를 정의할 때는 <code class="code docutils literal notranslate"><span class="pre">ForeignKey</span></code> 필드를 사용합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">headline</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>
    <span class="n">reporter</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;reporter&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">headline</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;headline&#39;</span><span class="p">,)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;johny1&#39;</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Johny&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;Smith&#39;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;johny@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;alien&#39;</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Alien&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;Mars&#39;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;alien@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;This is a test&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">reporter</span><span class="o">=</span><span class="n">u1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">id</span>
<span class="go">13</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">reporter</span>
<span class="go">&lt;User: johny1&gt;</span>
</pre></div>
</div>
<p>상위 객체를 데이터베이스에 저장하지 않은 채로 하위 객체에 할당하려 하면 <code class="code docutils literal notranslate"><span class="pre">ValueError</span></code> 예외가 발생합니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u3</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;someuser&#39;</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Some&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;some@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;This is a test&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">reporter</span><span class="o">=</span><span class="n">u3</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">ValueError</span>: <span class="n">save() prohibited to prevent data loss due to unsaved related object &#39;reporter&#39;.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;This is a test&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">reporter</span><span class="o">=</span><span class="n">u1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">reporter</span><span class="o">=</span><span class="n">u1</span><span class="p">)</span>
<span class="go">&lt;QuerySet [&lt;Article: This is a test&gt;, &lt;Article: This is a test&gt;]&gt;</span>
</pre></div>
</div>
<p>위 코드에서 구한 쿼리셋을 보면, u1 하나에 여러 개의 <code class="code docutils literal notranslate"><span class="pre">Article</span></code> 이 연결되어 있음(일대다 관계)을 확인할 수 있습니다.</p>
</div>
<span id="document-many_to_many"></span><div class="section" id="id1">
<h3>다대다 관계는 어떻게 나타내나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>다대다 관계란 한 표의 항목이 다른 표의 항목 여러 개를 가리킬 수 있고, 반대로 다른 표의 항목이 그 표의 항목을 여러 개 가리킬 수도 있는 관계입니다.</p>
<p>실제로 실행 가능한 예로, 트위터 앱을 다뤄 보겠습니다. 필드 몇 개와 <code class="code docutils literal notranslate"><span class="pre">ManyToMany</span></code> 필드만 있으면 간단한 트위터 앱을 만들 수 있습니다.</p>
<p>트위터의 핵심 기능으로 ‘트윗’, ‘팔로우’, ‘마음에 들어요’가 있습니다. 아래의 두 모델로 그 핵심 기능을 모두 구현할 수 있습니다. <code class="code docutils literal notranslate"><span class="pre">User</span></code> 모델은 장고의 사용자 인증 모델을 확장하여 정의했습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">AbstractUser</span><span class="p">):</span>
    <span class="n">tweet</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">follower</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Tweet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">tweet</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">favorite</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;user_favorite&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tweet</span>
</pre></div>
</div>
<p>이 모델로 할 수 있는 일은 다음과 같습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">)</span> <span class="n">사용자가</span> <span class="n">다른</span> <span class="n">사용자를</span> <span class="s1">&#39;팔로우&#39;</span> <span class="n">및</span> <span class="n">취소할</span> <span class="n">수</span> <span class="n">있습니다</span><span class="o">.</span>
<span class="mi">2</span><span class="p">)</span> <span class="n">사용자가</span> <span class="n">팔로우하는</span> <span class="n">다른</span> <span class="n">사용자가</span> <span class="n">작성한</span> <span class="n">트윗을</span> <span class="n">볼</span> <span class="n">수</span> <span class="n">있습니다</span><span class="o">.</span>
<span class="mi">3</span><span class="p">)</span> <span class="n">사용자가</span> <span class="n">트윗에</span> <span class="s1">&#39;마음에 들어요&#39;</span> <span class="n">및</span> <span class="n">취소할</span> <span class="n">수</span> <span class="n">있습니다</span><span class="o">.</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">ManyToMany</span></code> 필드로 수행할 수 있는 연산을 몇 가지 살펴볼 텐데, 그 전에 항목을 몇 개 생성해 둡시다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span> <span class="o">=</span> <span class="n">Tweet</span><span class="p">(</span><span class="n">tweet</span><span class="o">=</span><span class="s2">&quot;I am happy today&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t2</span> <span class="o">=</span> <span class="n">Tweet</span><span class="p">(</span><span class="n">tweet</span><span class="o">=</span><span class="s2">&quot;This is my second Tweet&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;johny1&#39;</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Johny&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;Smith&#39;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;johny@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;johny1&#39;</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Johny&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;Smith&#39;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;johny@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u3</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;someuser&#39;</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Some&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s1">&#39;some@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u3</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>생성한 항목들을 <code class="code docutils literal notranslate"><span class="pre">ManyToMany</span></code> 필드로 연결해 봅시다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># 사용자가 다른 사용자를 &#39;팔로우&#39; 할 수 있습니다.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">follow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># 트윗이 사용자에 연결되어 있습니다. 사용자들이 트윗에 마음에 들어요 및 취소를 할 수 있습니다.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">u3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># &#39;마음에 들어요&#39; 취소하기</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>완전히 동작하는 예제는 다음 저장소에서 확인해 주세요.</p>
<p><a class="reference external" href="https://github.com/yashrastogi16/simpletwitter">https://github.com/yashrastogi16/simpletwitter</a></p>
</div>
<span id="document-self_fk"></span><div class="section" id="id1">
<h3>모델에 자기 참조 외래 키를 정의할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>자기 참조 외래 키를 이용하여 중첩 관계·재귀 관계를 표현할 수 있습니다. 일대다 관계와 유사하지만, 이름에서 알 수 있듯이 모델이 자기 자신을 참조한다는 특징이 있습니다.</p>
<p>자기 참조 외래 키는 아래의 두 가지 방법으로 작성할 수 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Employee</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>

<span class="c1"># 또는</span>

<span class="k">class</span> <span class="nc">Employee</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;app.Employee&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<span id="document-existing_database"></span><div class="section" id="id1">
<h3>기존 데이터베이스를 장고 모델로 옮길 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>장고에는 기존 데이터베이스를 분석하여 그에 맞는 모델을 생성해주는 <code class="code docutils literal notranslate"><span class="pre">inspectdb</span></code> 명령이 있습니다. 셸에서 다음 명령을 실행하여 결과를 확인할 수 있습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python manage.py inspectdb
</pre></div>
</div>
<p>이 명령을 실행하려면 먼저 <code class="code docutils literal notranslate"><span class="pre">settings.py</span></code> 파일에 분석하려는 데이터베이스의 접속 정보를 설정해 두어야 합니다. 출력 결과는 생성된 모델의 파이썬 코드입니다. 코드를 파이썬 모듈 파일로 저장하려면 다음과 같이 셸의 스트림 리디렉션 기능을 이용합니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python manage.py inspectdb &gt; models.py
</pre></div>
</div>
<p>위 명령을 실행하면 분석된 모델이 파이썬 모듈 파일로 현재 디렉토리에 저장될 것입니다. 이 파일을 앱의 올바른 위치로 옮긴 뒤, 적절히 수정하여 사용하면 됩니다.</p>
</div>
<span id="document-database_view"></span><div class="section" id="id1">
<h3>데이터베이스 뷰에 대응하는 모델을 정의할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>데이터베이스 뷰는 데이터베이스 내에서 조회할 수 있도록 질의문으로 정의된 객체입니다. 뷰가 데이터를 물리적으로 저장하는 것은 아니지만, 실제 표와 같이 조회할 수 있기 때문에 ‘가상 표’라고 불리기도 합니다. 뷰는 여러 표를 결합(JOIN)한 정보를 보여줄 수도 있고, 한 표의 부분 집합만을 보여줄 수도 있습니다. 이를 활용하면 복잡한 질의문을 감추고 필요한 정보를 쉽게 조회하는 인터페이스를 만들 수 있습니다.</p>
<p>다음 스크린샷은 데이터베이스를 SQLiteStudio라는 프로그램으로 열어 본 모습입니다. 표가 26개 있고, 뷰는 없습니다.</p>
<img alt="_images/before_view.png" src="_images/before_view.png" />
<p>SQL 질의문을 실행하여 간단한 뷰를 생성하겠습니다.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">create</span> <span class="k">view</span> <span class="n">temp_user</span> <span class="k">as</span>
<span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">first_name</span>
<span class="k">from</span> <span class="n">auth_user</span><span class="p">;</span>
</pre></div>
</div>
<p>뷰가 생성되어 표 26개와 뷰 1개가 있습니다.</p>
<img alt="_images/after_view.png" src="_images/after_view.png" />
<p>장고 앱에서는 모델을 정의할 때 메타(<code class="code docutils literal notranslate"><span class="pre">Meta</span></code>) 클래스에 <code class="code docutils literal notranslate"><span class="pre">managed</span> <span class="pre">=</span> <span class="pre">False</span></code>, <code class="code docutils literal notranslate"><span class="pre">db_table=&quot;temp_user&quot;</span></code> 와 같이 옵션을 설정하여 뷰를 가리키는 모델로 사용할 수 있습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TempUser</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">managed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">db_table</span> <span class="o">=</span> <span class="s2">&quot;temp_user&quot;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="c1"># 실제 표와 마찬가지로 뷰를 조회할 수 있습니다.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">TempUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="o">&lt;</span><span class="n">QuerySet</span> <span class="p">[{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Yash&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Ricky&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Sharukh&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Ritesh&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Billy&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Radha&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Raghu&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Rishabh&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Paul&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Johny&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Alien&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">}]</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># 그러나 뷰에 기록은 하지 못합니다.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">TempUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Radhika&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="o">...</span>
<span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span> <span class="n">cannot</span> <span class="n">modify</span> <span class="n">temp_user</span> <span class="n">because</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">view</span>
</pre></div>
</div>
<p>union 연산이 있는 뷰는 아래 주소의 문서(Django Admin Cookbook)를 참고하세요.</p>
<p><a class="reference external" href="http://books.agiliq.com/projects/django-admin-cookbook/en/latest/database_view.html?highlight=view">http://books.agiliq.com/projects/django-admin-cookbook/en/latest/database_view.html?highlight=view</a></p>
</div>
<span id="document-generic_models"></span><div class="section" id="id1">
<h3>분류·댓글처럼 아무 모델이나 가리킬 수 있는 범용 모델을 정의할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>다음 모델을 봐 주세요.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="c1"># ...</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;Categories&quot;</span>


<span class="k">class</span> <span class="nc">Hero</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="c1"># ...</span>


<span class="k">class</span> <span class="nc">Villain</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>여기서 <code class="code docutils literal notranslate"><span class="pre">Category</span></code> 모델은 범용 모델로 고쳐 정의할 수 있습니다. 다른 모델에도 분류를 적용하고 싶을 테니까요. 다음과 같이 수정하면 됩니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.contenttypes.fields</span> <span class="kn">import</span> <span class="n">GenericForeignKey</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>
<span class="c1"># ...</span>

<span class="k">class</span> <span class="nc">FlexCategory</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">()</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">ContentType</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">object_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>
    <span class="n">content_object</span> <span class="o">=</span> <span class="n">GenericForeignKey</span><span class="p">(</span><span class="s1">&#39;content_type&#39;</span><span class="p">,</span> <span class="s1">&#39;object_id&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Hero</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">flex_category</span> <span class="o">=</span> <span class="n">GenericRelation</span><span class="p">(</span><span class="n">FlexCategory</span><span class="p">,</span> <span class="n">related_query_name</span><span class="o">=</span><span class="s1">&#39;flex_category&#39;</span><span class="p">)</span>
    <span class="c1"># ...</span>


<span class="k">class</span> <span class="nc">Villain</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">flex_category</span> <span class="o">=</span> <span class="n">GenericRelation</span><span class="p">(</span><span class="n">FlexCategory</span><span class="p">,</span> <span class="n">related_query_name</span><span class="o">=</span><span class="s1">&#39;flex_category&#39;</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>수정한 코드에서는 <code class="code docutils literal notranslate"><span class="pre">FlexCategory</span></code> 모델에 외래 키 필드(<code class="code docutils literal notranslate"><span class="pre">ForeignKey</span></code>) 하나와 양의 정수 필드(<code class="code docutils literal notranslate"><span class="pre">PositiveIntegerField</span></code>) 하나를 정의하여 범용 외래 키 필드(<code class="code docutils literal notranslate"><span class="pre">GenericForeignKey</span></code>)를 사용할 수 있도록 하였습니다. 그리고 분류를 이용할 모델에 범용 관계 필드(<code class="code docutils literal notranslate"><span class="pre">GenericRelation</span></code>)를 추가했습니다.</p>
<p><code class="code docutils literal notranslate"><span class="pre">FlexCategory</span></code> 모델의 데이터베이스 스키마는 다음과 같이 정의됩니다.</p>
<p><code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 모델의 항목을 분류할 때는 다음과 같이 합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hero</span> <span class="o">=</span> <span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Hades&#39;</span><span class="p">)</span>
<span class="n">FlexCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">content_object</span><span class="o">=</span><span class="n">hero</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mythic&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>‘ghost’로 분류된 <code class="code docutils literal notranslate"><span class="pre">Hero</span></code> 를 구하려면 다음과 같이 조회합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Hero</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">flex_category__name</span><span class="o">=</span><span class="s1">&#39;ghost&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>위의 ORM 코드가 생성하는 SQL 질의문은 아래와 같습니다.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;entities_hero&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;entities_hero&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;entities_flexcategory&quot;</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;entities_hero&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="ss">&quot;entities_flexcategory&quot;</span><span class="p">.</span><span class="ss">&quot;object_id&quot;</span>
                                       <span class="k">AND</span> <span class="p">(</span><span class="ss">&quot;entities_flexcategory&quot;</span><span class="p">.</span><span class="ss">&quot;content_type_id&quot;</span> <span class="o">=</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">WHERE</span> <span class="ss">&quot;entities_flexcategory&quot;</span><span class="p">.</span><span class="ss">&quot;name&quot;</span> <span class="o">=</span> <span class="n">ghost</span>
</pre></div>
</div>
</div>
<span id="document-table_name"></span><div class="section" id="id1">
<h3>모델에 연결된 표의 이름을 지정할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>여러분이 모델에 연결된 데이터베이스 표의 이름을 직접 지정하지 않으면 장고가 자동으로 표의 이름을 지어 줍니다. 자동으로 붙는 데이터베이스 표의 이름은 “앱의 레이블”(manage.py startapp 명령에서 지은 이름)과 모델 클래스의 이름을 밑줄 기호로 연결한 것이 됩니다.</p>
<p>이 책의 예제에서는 <code class="code docutils literal notranslate"><span class="pre">entities</span></code> 앱과 <code class="code docutils literal notranslate"><span class="pre">events</span></code> 앱을 사용했으므로 모든 모델의 표 이름이 <code class="code docutils literal notranslate"><span class="pre">entities_</span></code> 또는 <code class="code docutils literal notranslate"><span class="pre">events_</span></code> 로 시작합니다.</p>
<img alt="_images/db_table.png" src="_images/db_table.png" />
<p>이 이름을 직접 붙이시려면 모델의 <code class="code docutils literal notranslate"><span class="pre">Meta</span></code> 클래스에 <code class="code docutils literal notranslate"><span class="pre">db_table</span></code> 값을 설정하면 됩니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TempUser</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">db_table</span> <span class="o">=</span> <span class="s2">&quot;temp_user&quot;</span>
</pre></div>
</div>
</div>
<span id="document-column_name"></span><div class="section" id="id1">
<h3>모델 필드의 데이터베이스 열 이름을 지정할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>모델 필드가 가리키는 데이터베이스의 열 이름을 지정하려면 필드 인스턴스의 초기화 매개변수 <code class="code docutils literal notranslate"><span class="pre">db_column</span></code> 에 원하는 이름을 전달하면 됩니다. 이 매개변수에 인자를 전달하지 않으면 필드 이름과 동일한 이름이 사용됩니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ColumnName</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">db_column</span><span class="o">=</span><span class="s1">&#39;column1&#39;</span><span class="p">)</span>
    <span class="n">column2</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
</pre></div>
</div>
<img alt="_images/db_column.png" src="_images/db_column.png" />
<p>위 예에서 보듯, <code class="code docutils literal notranslate"><span class="pre">db_column</span></code> 으로 지정한 이름이 필드 이름보다 우선순위가 높습니다. 첫 번째 열의 이름이 a가 아니라 column1로 지어졌습니다.</p>
</div>
<span id="document-null_vs_blank"></span><div class="section" id="null-true-blank-true">
<h3><code class="code docutils literal notranslate"><span class="pre">null=True</span></code> 와 <code class="code docutils literal notranslate"><span class="pre">blank=True</span></code> 의 차이가 무엇인가요?<a class="headerlink" href="#null-true-blank-true" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">null</span></code> 과 <code class="code docutils literal notranslate"><span class="pre">blank</span></code> 는 둘 다 기본값이 <code class="code docutils literal notranslate"><span class="pre">False</span></code> 입니다. 이 두 설정은 모두 필드(열) 수준에서 동작합니다. 즉, 필드(열)를 비워두는 것을 허용할 것인지를 설정합니다.</p>
<p><code class="code docutils literal notranslate"><span class="pre">null=True</span></code> 는 필드의 값이 NULL(정보 없음)로 저장되는 것을 허용합니다. 결국 데이터베이스 열에 관한 설정입니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">blank=True</span></code> 는 필드가 폼(입력 양식)에서 빈 채로 저장되는 것을 허용합니다. 장고 관리자(admin) 및 직접 정의한 폼에도 반영됩니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 폼에서 비워둘 수 있음. 데이터베이스에는 &#39;&#39;이 저장됨.</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">null=True</span></code> 와 <code class="code docutils literal notranslate"><span class="pre">blank=True</span></code> 를 모두 지정하면 어떤 조건으로든 값을 비워둘 수 있음을 의미합니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">epic</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># 단, CharFields()와 TextFields()에서는 예외입니다.</span>
<span class="c1"># 장고는 이 경우 NULL을 저장하지 않으며, 빈 값을 빈 문자열(&#39;&#39;)로 저장합니다.</span>
</pre></div>
</div>
<p>또 하나 예외적인 경우가 있습니다. 불리언 필드(<code class="code docutils literal notranslate"><span class="pre">BooleanField</span></code>)에 NULL을 입력할 수 있도록 하려면 <code class="code docutils literal notranslate"><span class="pre">null=True</span></code> 를 설정하는 것이 아니라, 널 불리언 필드(<code class="code docutils literal notranslate"><span class="pre">NullBooleanField</span></code>)를 사용해야 합니다.</p>
</div>
<span id="document-uuid"></span><div class="section" id="pk-id-uuid">
<h3>기본 키(PK)로 ID 대신 UUID를 사용할 수 있나요?<a class="headerlink" href="#pk-id-uuid" title="Permalink to this headline">¶</a></h3>
<p>장고에서 모델을 생성하면 ID 필드가 기본 키로 생성됩니다. ID 필드의 기본 데이터 유형은 양의 정수입니다.</p>
<p>양의 정수가 아니라 UUID를 기본 키로 사용하고 싶다면 장고 1.8 버전에서 추가된 <code class="code docutils literal notranslate"><span class="pre">UUIDField</span></code> 를 사용하면 됩니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">details</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">years_ago</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">eventobject</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">eventobject</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
<span class="s1">&#39;3cd2b4b0c36f43488a93b3bb72029f46&#39;</span>
</pre></div>
</div>
</div>
<span id="document-slugfield"></span><div class="section" id="id1">
<h3>슬러그 필드를 사용할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>슬러그(<cite>slug</cite>)는 URL의 구성요소로 웹사이트의 특정 페이지를 가리키는 사람이 읽기 쉬운 형식의 식별자입니다. 장고에서는 슬러그 필드(<code class="code docutils literal notranslate"><span class="pre">SlugField</span></code>)로 슬러그를 지원합니다. 다음 예에서 사용법을 확인하실 수 있습니다. 앞서 살펴보았던 <code class="code docutils literal notranslate"><span class="pre">Article</span></code> 모델에 슬러그 필드를 추가해 가독성을 높여 보았습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.utils.text</span> <span class="k">import</span> <span class="n">slugify</span>
<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">headline</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
    <span class="n">slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slug</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headline</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a1</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;todays market report&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">reporter</span><span class="o">=</span><span class="n">u1</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="c1"># 슬러그는 자동으로 생성됩니다. create 메서드를 따로 정의한 게 아닙니다.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a1</span><span class="o">.</span><span class="n">slug</span>
<span class="s1">&#39;todays-market-report&#39;</span>
</pre></div>
</div>
<dl class="docutils">
<dt>슬러그의 장점:</dt>
<dd><div class="first last line-block">
<div class="line">사람이 이해하기 좋다. (<code class="code docutils literal notranslate"><span class="pre">/1/</span></code> 보다 <code class="code docutils literal notranslate"><span class="pre">/blog/</span></code> 가 좋다)</div>
<div class="line">제목과 URL을 동일하게 맞춰 검색엔진 최적화(SEO)에 도움이 된다.</div>
</div>
</dd>
</dl>
</div>
<span id="document-multiple_databases"></span><div class="section" id="id1">
<h3>장고 프로젝트 하나에서 여러 개의 데이터베이스를 사용할 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>데이터베이스의 접속에 관련된 설정은 대부분 <code class="code docutils literal notranslate"><span class="pre">settings.py</span></code> 파일에서 이루어집니다. 장고 프로젝트에 여러 개의 데이터베이스를 추가하려면 해당 파일의 <code class="code docutils literal notranslate"><span class="pre">DATABASES</span></code> 사전에 등록하면 됩니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DATABASE_ROUTERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;path.to.DemoRouter&#39;</span><span class="p">]</span>
<span class="n">DATABASE_APPS_MAPPING</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user_data&#39;</span><span class="p">:</span> <span class="s1">&#39;users_db&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;customer_data&#39;</span><span class="p">:</span><span class="s1">&#39;customers_db&#39;</span><span class="p">}</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.sqlite3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;db.sqlite3&#39;</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="s1">&#39;users_db&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;user_data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.postgresql&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;postgres_user&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;customers_db&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;customer_data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.mysql&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;mysql_cust&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>여러 개의 데이터베이스를 함께 사용하려면 데이터베이스 중계기(database router)에 대해 알아야 합니다. 장고의 기본 중계 설정은 데이터베이스를 특정하지 않은 경우 기본(default) 데이터베이스로 중계하는 것입니다. <code class="code docutils literal notranslate"><span class="pre">DATABASE_ROUTERS</span></code> 설정의 기본값은 <code class="code docutils literal notranslate"><span class="pre">[]</span></code> 입니다. 중계기는 다음과 같이 정의할 수 있습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DemoRouter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    user_data 앱의 모델에서 수행되는 모든 데이터베이스 연산을 제어하는 중계기</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        user_data 앱의 모델을 조회하는 경우 users_db로 중계한다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s1">&#39;user_data&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;users_db&#39;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        user_data 앱의 모델을 기록하는 경우 users_db로 중계한다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s1">&#39;user_data&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;users_db&#39;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">allow_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        user_data 앱의 모델과 관련된 관계 접근을 허용한다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">obj1</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s1">&#39;user_data&#39;</span> <span class="ow">or</span> \
           <span class="n">obj2</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s1">&#39;user_data&#39;</span><span class="p">:</span>
           <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">allow_migrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        user_data 앱의 모델에 대응하는 표가 users_db 데이터베이스에만 생성되도록 한다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">app_label</span> <span class="o">==</span> <span class="s1">&#39;user_data&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">db</span> <span class="o">==</span> <span class="s1">&#39;users_db&#39;</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>중계기를 위와 같이 설정해 두었으면, 모델이 서로 다른 데이터베이스를 사용하도록 다음과 같이 정의할 수 있습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Charfield</span><span class="p">(</span><span class="n">ax_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
        <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">app_label</span> <span class="o">=</span> <span class="s1">&#39;user_data&#39;</span>

<span class="k">class</span> <span class="nc">Customer</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
        <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">app_label</span> <span class="o">=</span> <span class="s1">&#39;customer_data&#39;</span>
</pre></div>
</div>
<p>여러 개의 데이터베이스를 관리할 때 사용하는 마이그레이션 명령도 알아두세요.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./manage.py migrate --database=users_db
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id5">
<h2>장고 ORM 코드를 테스트하는 방법<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-numqueries"></span><div class="section" id="id1">
<h3>질의 횟수가 고정된 횟수만큼만 일어나는지 확인할 수 있을까요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>장고 단위 테스트 클래스의 <code class="code docutils literal notranslate"><span class="pre">assertNumQueries()</span></code> 메서드를 사용하여 데이터베이스에 발생하는 질의 횟수를 검증할 수 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_number_of_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser1&#39;</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;user1&#39;</span><span class="p">)</span>
    <span class="c1"># 위 ORM 명령으로 질의 횟수가 1 번 일어나야 한다.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;test1user&#39;</span><span class="p">)</span>
    <span class="c1"># 질의 횟수가 한 번 증가해야 한다.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<span id="document-keepdb"></span><div class="section" id="id1">
<h3>데이터베이스를 재사용하여 테스트 실행 속도를 높일 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">test</span></code> 명령을 실행할 때마다 데이터베이스가 새로 생성됩니다. 이것은 마이그레이션이 많지 않을 때는 문제가 되지 않습니다. 하지만 마이그레이션이 많아질수록 테스트 실행 시 데이터베이스 재생성에 많은 시간을 소요하게 됩니다. 이런 상황을 피하기 위해 이전에 생성된 데이터베이스를 재사용할 수 있습니다.</p>
<p>테스트 명령에 <code class="code docutils literal notranslate"><span class="pre">--keepdb</span></code> 플래그를 추가하여 데이터베이스가 삭제되는 것을 방지하고 테스트 실행 간 데이터베이스를 유지할 수 있습니다.
데이터베이스가 존재하지 않으면 데이터베이스를 새로 생성합니다. 마지막 테스트 실행 이후 마이그레이션이 추가되었으면 최신 상태를 유지하기 위해 마이그레이션을 수행합니다.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python manage.py <span class="nb">test</span> --keepdb
</pre></div>
</div>
</div>
<span id="document-refresh_from_db"></span><div class="section" id="id1">
<h3>모델 객체를 데이터베이스에서 다시 읽어들일 수 있나요?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">refresh_from_db()</span></code> 메서드를 사용하여 데이터베이스에서 모델을 다시 읽어들일 수 있습니다. 값을 갱신하는 테스트를 작성할 때 유용한 기능입니다. 다음 예를 살펴보세요.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestORM</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_update_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">userobject</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
        <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;testuser&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;test1user&#39;</span><span class="p">)</span>
        <span class="c1"># 이 때, userobject 인스턴스의 username은 &#39;testuser&#39; 입니다.</span>
        <span class="c1"># 그러나 데이터베이스에서는 &#39;test1user&#39;로 수정되었습니다.</span>
        <span class="c1"># 모델 인스턴스의 속성이 데이터베이스와 맞지 않으므로 다시 읽어들입니다.</span>
        <span class="n">userobject</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">userobject</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s1">&#39;test1user&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2>찾아보기 / 표<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></li>
<li><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></li>
<li><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Agiliq
      
        <span class="commit">
          Revision <code>159ade05</code>.
        </span>
      

    </p>
  </div>
<p>
  <a href="https://books.agiliq.com"  class="btn">Read more books at https://books.agiliq.com</a>
</p>

<div class="other-books">
  <a href="http://books.agiliq.com/projects/django-api-polls-tutorial/">
    <img src="_static/book-covers/book-cover-api-320.png" />
  </a>
  <a href="https://books.agiliq.com/projects/django-admin-cookbook/">
    <img src="_static/book-covers/book-cover-dac-320.png" />
  </a>
  <a href="https://books.agiliq.com/projects/django-orm-cookbook/">
    <img src="_static/book-covers/book-cover-doc-320.png" />
  </a>
  <a href="https://books.agiliq.com/projects/django-multi-tenant/">
    <img src="_static/book-covers/book-cover-mta-320.png" />
  </a>
</div>
<script src="https://cdn1.pdmntn.com/a/SJH5AZ0mm.js"></script>


</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
          <dd><a href="/en/master/">master</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="//readthedocs.org/projects/django-orm-cookbook-ko/downloads/pdf/latest/">pdf</a></dd>
        
          <dd><a href="//readthedocs.org/projects/django-orm-cookbook-ko/downloads/htmlzip/latest/">htmlzip</a></dd>
        
          <dd><a href="//readthedocs.org/projects/django-orm-cookbook-ko/downloads/epub/latest/">epub</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/django-orm-cookbook-ko/?fromdocs=django-orm-cookbook-ko">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/django-orm-cookbook-ko/?fromdocs=django-orm-cookbook-ko">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'2.0',
              LANGUAGE:'en',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>